<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Boyfriend's Tsuki977Phone</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=VT323&display=swap" rel="stylesheet" />

    <style>
      :root {
        --bg-color: #fce7f3;
        --screen-bg: #eff6ff;
        --pixel-dark: #2e1065;
        --accent: #f43f5e;
        --btn-color: #fff;
      }

      body {
        font-family: 'DotGothic16', sans-serif;
        background-color: #11111100;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        overflow: hidden;
        user-select: none;
      }
      .font-mono {
        font-family: 'DotGothic16', sans-serif !important;
      }

      /* === æ»šåŠ¨æ¡ === */
      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: var(--pixel-dark);
        border-radius: 0px;
      }

      /* === ç‰©ç†æœºèº« === */
      .device-body {
        width: 297px;
        height: 606px;
        background-color: var(--bg-color);
        border: 6px solid #fff;
        border-radius: 37px;
        box-shadow: inset -5px -5px 15px rgba(0, 0, 0, 0.1), inset 5px 5px 15px rgba(255, 255, 255, 0.5),
          0 0 0 12px var(--pixel-dark);
        padding: 13px;
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        z-index: 1;
      }

      .screen-container {
        width: 100%;
        height: 515px;
        background: #000;
        border-radius: 22px;
        padding: 8px;
        box-shadow: inset 2px 2px 5px rgba(255, 255, 255, 0.1);
        margin-bottom: 0px;
        flex-shrink: 0;
        position: relative;
      }

      .lcd-display {
        background-color: var(--screen-bg);
        width: 100%;
        height: 100%;
        border-radius: 16px;
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        image-rendering: pixelated;
        background-image: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.05) 50%),
          linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
        background-size: 100% 3px, 3px 100%;
      }

      .chin-area {
        width: 100%;
        flex: 1;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        padding-top: 8px;
      }
      .home-btn {
        width: 49px;
        height: 49px;
        border-radius: 50%;
        background: var(--btn-color);
        border: 4px solid var(--pixel-dark);
        box-shadow: 4px 6px 0px rgba(0, 0, 0, 0.2), inset 2px 2px 10px rgba(255, 255, 255, 0.8);
        cursor: pointer;
        transition: active 0.1s;
      }
      .home-btn:active {
        transform: translateY(4px);
        box-shadow: 0px 2px 0px rgba(0, 0, 0, 0.2);
      }

      /* === UI Components === */
      .pixel-card {
        background: white;
        border: 2px solid var(--pixel-dark);
        box-shadow: 3px 3px 0px var(--pixel-dark);
        padding: 10px;
        margin-bottom: 12px;
        transition: transform 0.1s;
      }
      .pixel-card:active {
        transform: translate(2px, 2px);
        box-shadow: 1px 1px 0px var(--pixel-dark);
      }

      .status-bar {
        height: 24px;
        background: var(--pixel-dark);
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 8px;
        font-size: 10px;
        font-family: 'VT323', monospace;
        flex-shrink: 0;
        z-index: 50;
      }

      .app-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        padding: 12px 0;
        padding-bottom: 9px;
      }
      .app-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        cursor: pointer;
      }
      .app-icon {
        width: 44px;
        height: 44px;
        background: white;
        border: 2px solid var(--pixel-dark);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 2px 2px 0px rgba(0, 0, 0, 0.2);
        margin-bottom: 4px;
        transition: transform 0.1s;
      }
      .app-item:active .app-icon {
        transform: scale(0.9);
      }
      .app-name {
        font-size: 9px;
        font-weight: bold;
        color: var(--pixel-dark);
      }

      .app-view {
        position: absolute;
        inset: 0;
        z-index: 20;
        background: var(--screen-bg);
        display: flex;
        flex-direction: column;
        animation: fadeIn 0.2s;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .pixel-bubble {
        padding: 8px 10px;
        font-size: 11px;
        font-family: 'DotGothic16', sans-serif;
        position: relative;
        border: 2px solid var(--pixel-dark);
        box-shadow: 3px 3px 0px rgba(0, 0, 0, 0.2);
        max-width: 80%;
        line-height: 1.4;
      }
      .pixel-bubble-left {
        background: white;
        color: black;
        margin-right: 2px;
      }
      .pixel-bubble-right {
        background: #dcfce7;
        color: #14532d;
        margin-left: 2px;
      }

      .memo-tape {
        width: 30px;
        height: 10px;
        background: rgba(255, 255, 255, 0.4);
        position: absolute;
        top: -5px;
        left: 50%;
        transform: translateX(-50%);
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.1);
      }
      .memo-paper {
        background: #fefce8;
        border: 1px solid #d1d5db;
        box-shadow: 3px 3px 5px rgba(0, 0, 0, 0.1);
        padding: 12px;
        position: relative;
        cursor: pointer;
        transition: transform 0.2s;
      }
      .memo-paper:hover {
        transform: scale(1.05) rotate(0deg) !important;
        z-index: 10;
      }
      .memo-detail-bg {
        background-color: #fdf6e3;
        background-image: linear-gradient(#e5e7eb 1px, transparent 1px);
        background-size: 100% 24px;
      }

      .glitch-text {
        position: fixed;
        color: red;
        font-weight: bold;
        font-family: 'VT323', monospace;
        pointer-events: none;
        text-shadow: 2px 0px 0px black;
        animation: flash 0.2s infinite;
        z-index: 100;
      }
      @keyframes flash {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.3;
        }
      }

      .hidden {
        display: none !important;
      }
      .flex-center {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .ls-tab {
        flex: 1;
        text-align: center;
        padding: 8px 0;
        font-size: 10px;
        color: #666;
        cursor: pointer;
        background: #1a1a1a;
        border-top: 2px solid #333;
      }
      .ls-tab.active {
        color: var(--accent);
        border-top: 2px solid var(--accent);
        background: #000;
        font-weight: bold;
      }

      .bg-black {
        padding: 14px;
      }
      .pb-20 {
        padding-bottom: 1.5rem !important;
      }
      .p-6 {
        padding: 1.5rem 1rem !important;
      }
      #app-secret .flex-1.overflow-y-auto.p-4.relative {
        padding: 1rem 0rem;
      }

      /* Debug Overlay */
      #debug-overlay {
        position: fixed;
        bottom: 10px;
        left: 10px;
        z-index: 9999;
        opacity: 0.3;
        transition: opacity 0.3s;
      }
      #debug-overlay:hover {
        opacity: 1;
      }
      #debug-modal textarea {
        width: 100%;
        height: 200px;
        font-family: monospace;
        font-size: 10px;
        background: #111;
        color: #0f0;
        border: 1px solid #333;
        padding: 5px;
      }
    </style>
  </head>
  <body>
    <!-- DEBUG TOOLS -->
    <div id="debug-overlay">
      <button
        onclick="document.getElementById('debug-modal').classList.remove('hidden')"
        class="bg-black/80 text-white text-[10px] px-2 py-1 rounded border border-white/20"
      >
        DEBUG: æ³¨å…¥æ•°æ®
      </button>
    </div>
    <div id="debug-modal" class="fixed inset-0 bg-black/90 z-[10000] hidden flex-center flex-col p-4">
      <h3 class="text-white mb-2 font-mono">PASTE AI RESPONSE HERE</h3>
      <textarea
        id="debug-input"
        placeholder="Paste text containing <BOYFRIEND_DATA>..."
        class="leading-[14px]"
      ></textarea>
      <div class="flex gap-2 mt-2">
        <button
          onclick="compressDebugInput()"
          class="bg-amber-600 text-white px-4 py-2 rounded font-bold hover:bg-amber-500"
        >
          COMPRESS
        </button>
        <button
          onclick="formatDebugInput()"
          class="bg-blue-600 text-white px-4 py-2 rounded font-bold hover:bg-blue-500"
        >
          FORMAT
        </button>
        <button
          onclick="parseAndInject(document.getElementById('debug-input').value)"
          class="bg-green-600 text-white px-4 py-2 rounded font-bold hover:bg-green-500"
        >
          INJECT
        </button>
        <button
          onclick="document.getElementById('debug-modal').classList.add('hidden')"
          class="bg-red-600 text-white px-4 py-2 rounded font-bold hover:bg-red-500"
        >
          CLOSE
        </button>
      </div>
      <p id="debug-status" class="text-xs text-gray-400 mt-2 h-4"></p>
    </div>

    <div class="device-body">
      <div class="screen-container">
        <div class="lcd-display" id="screen-root">
          <div class="status-bar">
            <span id="carrier-text">OS</span>
            <div class="flex gap-2"><span id="battery-text">â™¥ 100%</span><span id="clock">22:00</span></div>
          </div>

          <div class="flex-1 overflow-hidden relative">
            <!-- LOCK SCREEN -->
            <div
              id="lock-screen"
              class="absolute inset-0 bg-[#eff6ff] z-50 flex flex-col items-center justify-center p-6"
            >
              <div class="w-24 h-24 border-4 border-slate-800 bg-white mb-6 flex-center rounded-2xl">
                <i data-lucide="heart" class="w-10 h-10 text-pink-500 animate-pulse fill-current"></i>
              </div>
              <h2 class="text-xl font-bold text-slate-800 mb-2" id="ls-title">LOCKED</h2>
              <p class="text-xs text-slate-500 mb-8 text-center px-4" id="ls-subtitle">Auth Required</p>
              <button
                onclick="unlockPhone()"
                id="ls-btn"
                class="pixel-card bg-pink-400 text-white border-pink-900 font-bold px-6 py-2 active:scale-95"
              >
                UNLOCK
              </button>
            </div>

            <!-- HOME SCREEN -->
            <div id="home-screen" class="absolute inset-0 z-10 hidden flex flex-col p-4 overflow-y-auto">
              <div
                class="bg-white border-2 border-slate-800 p-3 rounded-lg mb-4 flex justify-between items-center shadow-[4px_4px_0_0_rgba(30,41,59,1)]"
              >
                <div>
                  <div class="text-[10px] text-gray-400">CURRENT MOOD</div>
                  <div class="font-bold text-pink-600" id="home-mood-text">Mood Text</div>
                </div>
                <i data-lucide="eye" class="text-pink-600 w-6 h-6 animate-bounce"></i>
              </div>
              <div class="app-grid" id="app-grid-container"></div>
            </div>

            <!-- ALL APPS HTML STRUCTURE (No Data Hardcoded Here, Rendered by JS) -->

            <!-- FILES -->
            <div id="app-files" class="app-view hidden bg-[#f3f4f6]">
              <div class="h-10 bg-white border-b flex items-center px-4 justify-between">
                <span class="font-bold text-sm">æ–‡ä»¶æŸœ (ROOT)</span>
              </div>
              <div id="file-folders" class="p-4 grid grid-cols-2 gap-4"></div>
              <div id="folder-view" class="absolute inset-0 bg-[#f3f4f6] z-10 hidden flex flex-col">
                <div class="h-10 bg-white border-b flex items-center px-2 gap-2">
                  <button onclick="closeFolder()" class="p-1">
                    <i data-lucide="chevron-left" class="text-gray-600"></i></button
                  ><span id="folder-title" class="font-bold text-sm text-slate-800">Folder</span>
                </div>
                <div id="file-list" class="flex-1 p-2 space-y-2 overflow-y-auto"></div>
              </div>
              <div
                id="file-viewer"
                class="absolute inset-0 bg-black/95 z-50 hidden flex-col p-6 items-center justify-center text-center"
              >
                <div
                  class="w-full bg-gray-900 border border-gray-700 rounded-lg p-6 mb-4 relative overflow-hidden"
                  id="player-screen"
                ></div>
                <h3 id="file-name" class="font-bold text-white text-lg mb-2 font-mono">Filename</h3>
                <p id="file-desc" class="text-xs text-gray-400 font-mono mb-6 max-w-[80%]">Description</p>
                <button
                  onclick="document.getElementById('file-viewer').classList.add('hidden')"
                  class="text-xs text-gray-500 border border-gray-700 px-4 py-1 hover:text-white hover:border-white transition"
                >
                  CLOSE
                </button>
              </div>
            </div>

            <!-- MESSAGES -->
            <div id="app-messages" class="app-view hidden bg-gray-100">
              <div class="h-12 bg-white border-b border-gray-200 flex items-center px-4 justify-between shadow-sm z-10">
                <span class="font-bold text-slate-800" id="msg-header-text">TsukiChat</span>
              </div>
              <div class="flex-1 overflow-y-auto" id="msg-list"></div>
              <div id="chat-detail" class="absolute inset-0 bg-[#f5f5f5] z-30 hidden flex flex-col">
                <div class="h-12 bg-white border-b border-gray-200 flex items-center px-3 gap-2 shadow-sm">
                  <button onclick="toggleElement('chat-detail')" class="p-1">
                    <i data-lucide="chevron-left" class="text-gray-600"></i></button
                  ><span class="font-bold text-sm text-slate-800" id="chat-title">Chat</span>
                </div>
                <div class="flex-1 p-3 space-y-3 overflow-y-auto bg-[#ededed]" id="chat-content"></div>
              </div>
            </div>

            <!-- LOVESYNC -->
            <div id="app-lovesync" class="app-view hidden bg-[#0f0f10]">
              <div class="h-10 bg-pink-900 text-white flex items-center px-3 border-b border-pink-800 justify-between">
                <span class="font-bold text-sm tracking-wider">â™¥ CONTROL CENTER</span>
                <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
              </div>
              <div class="flex-1 overflow-hidden relative">
                <div id="ls-view-control" class="absolute inset-0 p-4 overflow-y-auto">
                  <div class="h-28 border border-pink-800 bg-black mb-4 flex-center relative">
                    <div class="text-pink-500 font-mono text-center">
                      <div class="text-3xl animate-bounce mb-1">â™¥</div>
                      <div class="text-[10px]">LINKED: BABY</div>
                    </div>
                  </div>
                  <div class="grid grid-cols-2 gap-3 mb-4" id="ls-controls-container"></div>
                  <div
                    class="h-40 border border-gray-800 p-2 font-mono text-[9px] text-green-500 overflow-y-auto"
                    id="ls-logs"
                  >
                    <p>> ç³»ç»Ÿå°±ç»ªã€‚</p>
                  </div>
                </div>
                <div id="ls-view-status" class="absolute inset-0 p-4 overflow-y-auto hidden bg-black">
                  <h3 class="text-pink-600 font-bold border-b border-pink-900 pb-1 mb-3 text-sm">SUBJECT: ME</h3>
                  <div class="space-y-4" id="ls-status-container"></div>
                </div>
                <div id="ls-view-diary" class="absolute inset-0 p-4 overflow-y-auto hidden bg-black">
                  <h3 class="text-pink-600 font-bold border-b border-pink-900 pb-1 mb-3 text-sm">OBSERVATION LOGS</h3>
                  <div class="space-y-3" id="ls-diary-container"></div>
                </div>
              </div>
              <div class="flex border-t border-gray-800">
                <div class="ls-tab active" data-target="control" onclick="switchLsTab('control')">æ§åˆ¶</div>
                <div class="ls-tab" data-target="status" onclick="switchLsTab('status')">çŠ¶æ€</div>
                <div class="ls-tab" data-target="diary" onclick="switchLsTab('diary')">æ—¥è®°</div>
              </div>
            </div>

            <!-- MUSIC -->
            <div id="app-music" class="app-view hidden bg-[#111] flex flex-col text-white">
              <div
                class="h-14 bg-gradient-to-b from-rose-900 to-[#111] flex items-center px-4 border-b border-rose-900/30 shrink-0"
              >
                <span class="font-bold text-lg font-mono tracking-widest text-rose-500">MUSIC PLAYER</span
                ><i data-lucide="music" class="w-5 h-5 ml-auto text-rose-500"></i>
              </div>
              <div class="flex-1 overflow-y-auto p-4 space-y-6" id="music-container"></div>
              <div class="h-12 bg-[#222] border-t border-gray-800 flex items-center px-3 gap-3 shrink-0">
                <div class="w-8 h-8 bg-rose-800 rounded flex-center animate-pulse">
                  <i data-lucide="disc" class="w-4 h-4 animate-spin"></i>
                </div>
                <div class="flex-1">
                  <div class="text-[10px] font-bold text-gray-200">å‘¼å¸ (Sampling)</div>
                  <div class="text-[8px] text-gray-500">Playing...</div>
                </div>
                <i data-lucide="pause" class="w-4 h-4 text-white fill-current"></i>
              </div>
            </div>
            <!-- Music Modal -->
            <div
              id="music-ticket-modal"
              class="absolute inset-0 z-50 bg-black/80 hidden flex-center p-4 backdrop-blur-sm"
            >
              <div
                class="relative bg-[#fff1f2] w-full max-w-xs shadow-2xl flex flex-col overflow-hidden"
                style="
                  clip-path: polygon(
                    0 0,
                    100% 0,
                    100% 100%,
                    95% 98%,
                    90% 100%,
                    85% 98%,
                    80% 100%,
                    75% 98%,
                    70% 100%,
                    65% 98%,
                    60% 100%,
                    55% 98%,
                    50% 100%,
                    45% 98%,
                    40% 100%,
                    35% 98%,
                    30% 100%,
                    25% 98%,
                    20% 100%,
                    15% 98%,
                    10% 100%,
                    5% 98%,
                    0 100%
                  );
                  padding-bottom: 10px;
                "
              >
                <div
                  class="bg-rose-500 p-3 border-b-2 border-dashed border-rose-300 flex justify-between items-center text-white"
                >
                  <span class="font-bold tracking-widest text-xs font-mono">TICKET No.0520</span
                  ><button onclick="toggleElement('music-ticket-modal')" class="hover:text-black font-bold">âœ•</button>
                </div>
                <div class="p-4 flex-1 overflow-y-auto max-h-[400px]">
                  <div class="text-center mb-4">
                    <h2 id="mt-title" class="text-xl font-bold text-rose-900 mb-1 font-mono uppercase tracking-tight">
                      SONG TITLE
                    </h2>
                    <p id="mt-desc" class="text-[9px] text-rose-400 italic leading-tight">Description here</p>
                  </div>
                  <div class="border-t-2 border-b-2 border-rose-200 py-4 my-2 bg-rose-50/50">
                    <div
                      id="mt-lyrics"
                      class="text-xs text-slate-800 font-mono leading-relaxed text-center whitespace-pre-wrap"
                    >
                      Lyrics...
                    </div>
                  </div>
                  <div
                    class="mt-4 h-8 w-3/4 mx-auto opacity-80"
                    style="
                      background-image: linear-gradient(90deg, transparent 50%, black 50%);
                      background-size: 3px 100%;
                    "
                  ></div>
                  <div class="text-[8px] text-center text-gray-400 mt-1 font-mono">BF-REC-2025-OFFICIAL</div>
                </div>
              </div>
            </div>

            <!-- GAME -->
            <div id="app-game" class="app-view hidden bg-[#2e1065] flex flex-col">
              <div
                class="h-12 bg-[#4c1d95] text-white flex items-center px-4 shadow-md z-10 border-b-2 border-[#5b21b6] justify-between shrink-0"
              >
                <span class="font-bold text-lg font-mono tracking-widest">GAME LIBRARY</span
                ><i data-lucide="joystick" class="w-5 h-5"></i>
              </div>
              <div class="p-4 grid grid-cols-1 gap-3 overflow-y-auto" id="game-list"></div>
              <div id="game-modal" class="absolute inset-0 z-50 bg-black/80 hidden flex-center p-6 backdrop-blur-sm">
                <div class="bg-white border-4 border-[#4c1d95] p-0 w-full max-w-xs shadow-2xl relative flex flex-col">
                  <div class="bg-[#4c1d95] text-white p-2 flex justify-between items-center">
                    <span class="font-bold text-xs" id="gm-name">GAME NAME</span
                    ><button onclick="toggleElement('game-modal')" class="text-white hover:text-red-300">âœ•</button>
                  </div>
                  <div class="p-4 bg-[#f3e8ff]">
                    <div class="mb-4">
                      <span class="bg-[#4c1d95] text-white text-[9px] px-1 py-0.5 rounded">æ¸¸ç©åŠ¨æœº</span>
                      <p class="text-xs text-[#4c1d95] mt-1 font-bold leading-tight" id="gm-reason">...</p>
                    </div>
                    <div>
                      <span class="bg-pink-600 text-white text-[9px] px-1 py-0.5 rounded">é€šå…³è¯„ä»·</span>
                      <p
                        class="text-[10px] text-slate-700 mt-1 font-mono leading-relaxed border-l-2 border-pink-400 pl-2"
                        id="gm-review"
                      >
                        ...
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- SHOPPING -->
            <div id="app-shopping" class="app-view hidden bg-[#fff7ed]">
              <div
                class="h-10 bg-orange-500 text-white flex items-center px-3 border-b border-orange-600 shadow-sm justify-between"
              >
                <span class="font-bold text-sm">æˆ‘çš„è´­ç‰©è½¦</span><i data-lucide="shopping-cart" class="w-4 h-4"></i>
              </div>
              <div class="flex-1 overflow-y-auto p-2 space-y-2" id="shopping-list"></div>
            </div>

            <!-- WARDROBE -->
            <div id="app-wardrobe" class="app-view hidden bg-[#f3e8ff]">
              <div
                class="h-10 bg-purple-600 text-white flex items-center px-3 border-b border-purple-700 shadow-sm justify-between"
              >
                <span class="font-bold text-sm">å¥¹çš„è¡£æŸœ</span><i data-lucide="shirt" class="w-4 h-4"></i>
              </div>
              <div class="flex-1 overflow-y-auto p-3 grid grid-cols-2 gap-3" id="wardrobe-grid"></div>
              <div
                id="wardrobe-modal"
                class="absolute inset-0 z-50 bg-black/50 hidden flex-center p-6 backdrop-blur-sm"
              >
                <div class="bg-white border-4 border-purple-400 p-4 w-full max-w-xs shadow-xl relative">
                  <button
                    onclick="closeWardrobeModal()"
                    class="absolute top-2 right-2 text-gray-400 hover:text-purple-600"
                  >
                    âœ•
                  </button>
                  <div class="flex flex-col items-center text-center">
                    <div id="wd-icon" class="mb-3"></div>
                    <h3 id="wd-name" class="font-bold text-lg text-purple-900 mb-1">Item Name</h3>
                    <div id="wd-rating" class="text-xs mb-3 font-bold text-pink-500"></div>
                    <div class="bg-purple-50 p-3 rounded border border-purple-100 w-full text-left">
                      <p id="wd-comment" class="text-sm text-purple-800 font-mono leading-relaxed"></p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- MEMO -->
            <div id="app-memo" class="app-view hidden bg-[#e5e7eb] overflow-hidden">
              <div class="h-12 bg-[#374151] flex items-center px-4 shadow-md z-10 sticky top-0 border-b-2 border-black">
                <span class="font-bold text-white text-lg font-mono tracking-widest">NOTES</span>
              </div>
              <div class="p-6 overflow-y-auto pb-20 space-y-6" id="memo-container"></div>
              <div id="memo-modal" class="absolute inset-0 z-50 bg-black/50 hidden flex-center p-4 backdrop-blur-sm">
                <div
                  class="bg-[#fdf6e3] w-full max-w-xs shadow-2xl relative transform rotate-1 memo-detail-bg p-0 border border-gray-400"
                >
                  <div class="h-12 border-b border-red-300 flex items-center px-4">
                    <span class="text-red-400 font-bold text-xs">DATE: 2025.11.28</span
                    ><button onclick="toggleElement('memo-modal')" class="ml-auto text-gray-400 hover:text-red-500">
                      âœ•
                    </button>
                  </div>
                  <div class="p-6 min-h-[300px]">
                    <h2 id="memo-modal-title" class="text-xl font-bold text-slate-800 mb-4 font-mono">Title</h2>
                    <p id="memo-modal-content" class="text-sm text-slate-700 leading-8 font-mono whitespace-pre-wrap">
                      Content
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <!-- GALLERY -->
            <div id="app-gallery" class="app-view hidden bg-white">
              <div class="h-10 border-b flex items-center px-4 justify-between">
                <span class="font-bold">ç›¸å†Œ</span>
              </div>
              <div class="p-1 grid grid-cols-3 gap-1 overflow-y-auto" id="gallery-grid"></div>
              <div id="lightbox" class="absolute inset-0 bg-black z-40 hidden flex-col justify-center items-center p-4">
                <div class="w-full h-64 bg-gray-800 flex items-center justify-center mb-4 relative overflow-hidden">
                  <i data-lucide="image" class="w-12 h-12 text-gray-600"></i>
                </div>
                <h3 id="lb-title" class="text-white font-bold mb-2">Title</h3>
                <p id="lb-desc" class="text-gray-400 text-xs text-center">Desc</p>
                <button
                  onclick="toggleElement('lightbox')"
                  class="mt-8 text-white border border-white px-4 py-1 text-xs"
                >
                  å…³é—­
                </button>
              </div>
            </div>

            <!-- BROWSER -->
            <div id="app-browser" class="app-view hidden bg-white flex flex-col">
              <div class="bg-gray-100 p-2 border-b border-gray-300 flex gap-2 items-center">
                <div class="w-2 h-2 rounded-full bg-red-400"></div>
                <div class="w-2 h-2 rounded-full bg-yellow-400"></div>
                <div
                  class="flex-1 bg-white border border-gray-300 rounded px-2 text-[10px] text-gray-500 h-6 flex items-center truncate"
                >
                  https://search.darkweb.onion/query=control...
                </div>
              </div>
              <div class="flex-1 p-4 overflow-y-auto">
                <h3 class="font-bold text-xs text-gray-500 mb-3">å†å²è®°å½• - ä»Šå¤©</h3>
                <div class="space-y-3" id="browser-history"></div>
              </div>
            </div>
            <div
              id="browser-note-modal"
              class="absolute inset-0 z-50 bg-black/60 hidden flex-center p-6 backdrop-blur-sm"
            >
              <div
                id="bn-container"
                class="bg-blue-50 w-full border-4 border-blue-800 shadow-2xl relative p-0 flex flex-col max-h-[400px]"
              >
                <div
                  id="bn-header"
                  class="bg-blue-800 text-white px-3 py-2 flex justify-between items-center border-b-4 border-blue-900"
                >
                  <span class="font-bold text-xs tracking-widest">LEARNING_LOG.txt</span
                  ><button onclick="toggleElement('browser-note-modal')" class="hover:text-white/80">âœ•</button>
                </div>
                <div class="p-4 overflow-y-auto font-mono">
                  <h2 id="bn-title" class="text-lg font-bold text-blue-900 mb-4 border-b border-blue-200 pb-2">
                    Title
                  </h2>
                  <div id="bn-content" class="text-xs text-slate-700 leading-relaxed whitespace-pre-wrap">Content</div>
                </div>
                <div
                  id="bn-footer"
                  class="bg-blue-100 p-2 text-[9px] text-blue-400 text-center border-t border-blue-200"
                >
                  AUTO-SAVED TO CLOUD
                </div>
              </div>
            </div>

            <!-- ANNIVERSARY -->
            <div id="app-anniversary" class="app-view hidden bg-[#fff1f2]">
              <div
                class="h-12 bg-[#be123c] text-white flex items-center px-4 shadow-md z-10 sticky top-0 border-b-2 border-[#881337] justify-between"
              >
                <span class="font-bold text-lg font-mono tracking-widest">ANNIVERSARY</span
                ><i data-lucide="calendar" class="w-5 h-5"></i>
              </div>
              <div class="p-4 overflow-y-auto pb-20 space-y-4" id="anniversary-list"></div>
            </div>

            <!-- LOCATION -->
            <div id="app-location" class="app-view hidden bg-[#1e293b] flex flex-col">
              <div class="h-10 bg-slate-800 text-white flex items-center px-4 z-10 shadow-md border-b border-slate-700">
                <span class="font-bold text-sm">å®šä½è¿½è¸ª</span
                ><span class="ml-auto text-[10px] text-green-400 flex items-center gap-1 font-mono"
                  ><div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                  SIGNAL: STRONG</span
                >
              </div>
              <div class="flex-1 relative overflow-hidden" id="map-container">
                <div
                  class="absolute inset-0 opacity-20"
                  style="
                    background-image: linear-gradient(#fff 1px, transparent 1px),
                      linear-gradient(90deg, #fff 1px, transparent 1px);
                    background-size: 20px 20px;
                  "
                ></div>
                <svg id="map-lines" class="absolute inset-0 w-full h-full pointer-events-none" style="z-index: 0"></svg>
                <div id="map-points" class="absolute inset-0 w-full h-full z-10"></div>
              </div>
              <div class="h-1/3 bg-slate-900 border-t-2 border-slate-600 p-0 flex flex-col">
                <div
                  class="px-3 py-1 bg-slate-800 text-[10px] text-gray-400 font-bold border-b border-slate-700 flex justify-between"
                >
                  <span>ACTIVITY LOG</span><span>LIVE FEED</span>
                </div>
                <div id="location-logs" class="flex-1 overflow-y-auto p-3 space-y-3 font-mono"></div>
              </div>
            </div>

            <!-- MOMENTS -->
            <div id="app-moments" class="app-view hidden bg-gray-50">
              <div class="h-12 bg-white border-b flex items-center px-4"><span class="font-bold">æœ‹å‹åœˆ</span></div>
              <div id="moments-list" class="p-0"></div>
            </div>

            <!-- TASKS -->
            <div id="app-tasks" class="app-view hidden bg-[#ccfbf1] flex flex-col">
              <div
                class="h-12 bg-teal-600 text-white flex items-center px-4 shadow-md z-10 border-b-2 border-teal-800 justify-between"
              >
                <span class="font-bold text-lg font-mono tracking-widest">MISSIONS</span
                ><i data-lucide="clipboard-check" class="w-5 h-5"></i>
              </div>
              <div class="p-4 flex-1 overflow-y-auto">
                <div class="bg-white border-2 border-teal-500 p-3 mb-4 shadow-[4px_4px_0_0_rgba(20,184,166,0.5)]">
                  <div class="flex justify-between text-xs font-bold text-teal-800 mb-1">
                    <span>ä¹–å·§åº¦ (PROGRESS)</span><span id="task-percent">0%</span>
                  </div>
                  <div class="w-full h-3 bg-gray-200 border border-teal-800 rounded-full overflow-hidden">
                    <div id="task-bar" class="h-full bg-teal-500 w-0 transition-all duration-500"></div>
                  </div>
                  <div id="task-reward" class="mt-2 text-[10px] text-center text-teal-600 font-mono hidden">
                    ğŸ‰ å¥–åŠ±å·²æ¿€æ´»ï¼š<span id="task-reward-text" class="font-bold"></span>
                  </div>
                </div>
                <div id="task-list" class="space-y-2"></div>
              </div>
            </div>

            <!-- GACHA -->
            <div id="app-gacha" class="app-view hidden bg-[#fdf4ff] flex flex-col items-center justify-center">
              <div
                class="absolute top-0 w-full h-12 bg-fuchsia-600 text-white flex items-center px-4 shadow-md border-b-2 border-fuchsia-800 justify-between"
              >
                <span class="font-bold text-lg font-mono tracking-widest">FATE_GACHA</span
                ><i data-lucide="gift" class="w-5 h-5"></i>
              </div>
              <div
                class="relative w-64 h-80 bg-white border-4 border-fuchsia-800 flex flex-col items-center p-4 shadow-[8px_8px_0_0_rgba(192,38,211,0.4)]"
              >
                <div
                  class="w-full h-40 bg-fuchsia-100 border-2 border-fuchsia-300 mb-4 flex items-center justify-center overflow-hidden relative"
                >
                  <div id="gacha-display" class="text-center">
                    <i data-lucide="help-circle" class="w-12 h-12 text-fuchsia-300 mx-auto mb-2 animate-bounce"></i>
                    <p class="text-xs text-fuchsia-400 font-mono">ç‚¹å‡»æŒ‰é’®æŠ½å–</p>
                  </div>
                </div>
                <button
                  onclick="playGacha()"
                  class="w-full py-3 bg-fuchsia-500 text-white font-bold border-b-4 border-fuchsia-700 active:border-b-0 active:translate-y-1 transition-all"
                >
                  PULL (100 Pts)
                </button>
                <p class="mt-4 text-[10px] text-gray-400 text-center px-2">
                  *ç»“æœä»…ä¾›æƒ…è¶£äº’åŠ¨ä½¿ç”¨ã€‚<br />è§£é‡Šæƒå½’ç”·å‹æ‰€æœ‰ã€‚
                </p>
              </div>
            </div>

            <!-- SECRET -->
            <div id="app-secret" class="app-view hidden bg-black flex flex-col text-red-600">
              <div class="h-12 border-b-2 border-red-900 flex items-center px-4 justify-between bg-[#1a0505]">
                <span class="font-bold text-lg font-mono tracking-widest animate-pulse">RESTRICTED AREA</span
                ><i data-lucide="alert-triangle" class="w-5 h-5"></i>
              </div>
              <div class="flex border-b border-red-900/50">
                <button
                  class="flex-1 py-2 text-xs font-bold hover:bg-red-900/20 active:bg-red-900/40 transition"
                  onclick="switchSecretTab('audio')"
                >
                  éŸ³é¢‘</button
                ><button
                  class="flex-1 py-2 text-xs font-bold hover:bg-red-900/20 active:bg-red-900/40 transition"
                  onclick="switchSecretTab('photo')"
                >
                  ç§ç…§</button
                ><button
                  class="flex-1 py-2 text-xs font-bold hover:bg-red-900/20 active:bg-red-900/40 transition"
                  onclick="switchSecretTab('fantasy')"
                >
                  å¹»æƒ³
                </button>
              </div>
              <div class="flex-1 overflow-y-auto p-4 relative"><div id="secret-content" class="space-y-4"></div></div>
              <div id="secret-modal" class="absolute inset-0 z-50 bg-black/95 hidden flex-center p-4 backdrop-blur-sm">
                <div
                  class="bg-[#0f0000] w-full border-4 border-red-800 shadow-[0_0_20px_rgba(220,38,38,0.4)] relative flex flex-col max-h-[80%]"
                >
                  <div class="bg-red-900/40 border-b border-red-800 p-2 flex justify-between items-center">
                    <span class="text-red-500 font-bold text-xs tracking-widest uppercase font-mono" id="sm-type"
                      >DATA_LOG</span
                    ><button onclick="toggleElement('secret-modal')" class="text-red-500 hover:text-white px-2">
                      âœ•
                    </button>
                  </div>
                  <div class="p-5 overflow-y-auto">
                    <h3
                      id="sm-title"
                      class="text-xl font-bold text-red-600 mb-4 border-b border-red-900/50 pb-2 font-mono"
                    >
                      Title
                    </h3>
                    <div id="sm-content" class="text-xs text-red-400/90 font-mono leading-relaxed whitespace-pre-wrap">
                      Content
                    </div>
                  </div>
                  <div class="p-2 border-t border-red-900/30 text-[9px] text-red-900 text-center font-mono">
                    CLASSIFIED CONTENT - DO NOT SHARE
                  </div>
                </div>
              </div>
            </div>

            <!-- COLLECTION -->
            <div id="app-collection" class="app-view hidden bg-[#18181b] flex flex-col text-gray-300">
              <div class="h-12 border-b border-gray-700 flex items-center px-4 justify-between bg-[#27272a] shadow-lg">
                <span class="font-bold text-sm tracking-widest text-gray-100">MY SHRINE (æ”¶è—å®¤)</span
                ><i data-lucide="archive" class="w-4 h-4"></i>
              </div>
              <div class="flex-1 overflow-y-auto p-4 grid grid-cols-2 gap-3" id="collection-grid"></div>
              <div
                id="collection-modal"
                class="absolute inset-0 z-50 bg-black/80 hidden flex-center p-6 backdrop-blur-sm"
              >
                <div class="bg-[#27272a] w-full border-2 border-zinc-500 shadow-2xl relative flex flex-col p-0">
                  <div class="bg-zinc-700 text-white p-2 flex justify-between items-center">
                    <span class="font-bold text-xs tracking-wider">ITEM DETAIL</span
                    ><button onclick="toggleElement('collection-modal')" class="hover:text-gray-300">âœ•</button>
                  </div>
                  <div class="p-6 flex flex-col items-center">
                    <div class="w-24 h-24 bg-black/50 border border-zinc-600 flex-center mb-4 rounded shadow-inner">
                      <i data-lucide="package" class="w-10 h-10 text-zinc-500"></i>
                    </div>
                    <h3 id="cm-item" class="text-lg font-bold text-zinc-200 mb-2">Item Name</h3>
                    <span id="cm-date" class="text-[9px] bg-zinc-800 text-zinc-400 px-2 py-1 rounded mb-4 font-mono"
                      >Date</span
                    >
                    <p
                      id="cm-desc"
                      class="text-xs text-zinc-400 text-left w-full border-t border-zinc-600 pt-3 font-mono leading-7"
                    >
                      Description...
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <!-- SETTINGS -->
            <div id="app-settings" class="absolute inset-0 bg-black z-50 hidden overflow-hidden">
              <div id="glitch-layer" class="absolute inset-0 pointer-events-none"></div>
              <div class="relative z-10 flex flex-col items-center justify-center h-full text-center p-8">
                <h1 class="text-5xl font-bold bg-red-600 text-black px-4 py-1 mb-6 animate-pulse" id="settings-title">
                  ERROR
                </h1>
                <button onclick="lockPhone()" class="border border-red-800 text-red-800 px-6 py-2 text-xs">
                  [ å¼ºåˆ¶é‡å¯ ]
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="chin-area"><button class="home-btn" onclick="handlePhysicalHome()"></button></div>
    </div>

    <script>
      // ==========================================
      //         é»˜è®¤æ•°æ® (DEFAULT DATA)
      // ==========================================
      let filesData = {
        system: {
          carrier: '[è¿è¥å•†åç§°-ä½“ç°å æœ‰æ¬²]',
          battery: '[ç”µé‡%-ä½“ç°å¿ƒæƒ…çŠ¶æ€]',
          lockScreen: {
            title: '[é”å±ä¸»æ ‡é¢˜]',
            subtitle: '[ç”Ÿç‰©è®¤è¯é€šè¿‡æç¤º+å½“å‰ç›‘è§†çŠ¶æ€]',
            button: '[è§£é”æŒ‰é’®æ–‡æœ¬]',
          },
          home: { mood: '[å½“å‰å¿ƒæƒ…å…³é”®è¯ (è‹±æ–‡ç¿»è¯‘)]' },
          settings: { errorText: '[ç³»ç»Ÿé”™è¯¯æç¤º-ä½“ç°æ— æ³•ç¦»å¼€]' },
          location: { targetText: '[å®šä½ç›®æ ‡æç¤ºæ–‡æœ¬]' },
        },

        apps: [
          { id: 'lovesync', name: 'LoveSync', icon: 'gamepad-2', color: 'pink' },
          { id: 'messages', name: 'TsukiChat', icon: 'message-circle', color: 'green' },
          { id: 'music', name: 'éŸ³ä¹', icon: 'music', color: 'rose' },
          { id: 'game', name: 'æ¸¸æˆ', icon: 'joystick', color: 'violet' },
          { id: 'shopping', name: 'è´­ç‰©è½¦', icon: 'shopping-cart', color: 'orange' },
          { id: 'wardrobe', name: 'è¡£æŸœ', icon: 'shirt', color: 'purple' },
          { id: 'files', name: 'æ–‡ä»¶ç®¡ç†', icon: 'folder-open', color: 'amber' },
          { id: 'gallery', name: 'ç›¸å†Œ', icon: 'image', color: 'yellow' },
          { id: 'browser', name: 'æµè§ˆå™¨', icon: 'globe', color: 'blue' },
          { id: 'location', name: 'è½¨è¿¹', icon: 'map-pin', color: 'cyan' },
          { id: 'memo', name: 'å¤‡å¿˜å½•', icon: 'sticky-note', color: 'indigo' },
          { id: 'moments', name: 'åŠ¨æ€', icon: 'aperture', color: 'rose' },
          { id: 'anniversary', name: 'çºªå¿µæ—¥', icon: 'calendar', color: 'red' },
          { id: 'tasks', name: 'ä¹–å®å®ä»»åŠ¡', icon: 'clipboard-check', color: 'teal' },
          { id: 'gacha', name: 'å‘½è¿æ‰­è›‹', icon: 'gift', color: 'fuchsia' },
          { id: 'secret', name: 'æ·±å±‚ç©ºé—´', icon: 'lock', color: 'slate', iconColor: 'red-600' },
          { id: 'collection', name: 'æ”¶è—å®¤', icon: 'archive', color: 'zinc' },
          { id: 'settings', name: 'è®¾ç½®', icon: 'settings', color: 'slate', iconColor: 'black' },
        ],
        content: {
          messages: {
            list: [
              { id: 'gf', name: '[ä¸»è§’çˆ±ç§°]', top: true, msg: '[æœ€æ–°ä¸€æ¡æ¶ˆæ¯é¢„è§ˆ]', time: '[æ—¶é—´]' },
              { id: 'express', name: '[æœåŠ¡å·åç§°-å¦‚å¿«é€’]', top: false, msg: '[ç‰©å“é€è¾¾é€šçŸ¥]', time: '[æ—¶é—´]' },
              { id: 'blocked', name: '[è¢«æ‹‰é»‘çš„äºº]', top: false, msg: '[æ¶ˆæ¯æ‹’æ”¶æç¤º]', time: '[æ—¶é—´]' },
            ],
            details: {
              gf: [
                { s: 'right', t: '[æˆ‘å‘é€çš„æ¶ˆæ¯å†…å®¹-ä½“ç°ç„¦æ€¥/æ·±æƒ…]', time: '[æ—¶é—´]' },
                { s: 'left', t: '[å¥¹å›å¤çš„æ¶ˆæ¯]', time: '[æ—¶é—´]' },
              ],
              express: [{ s: 'left', t: '[ç‰©æµè¯¦æƒ…é€šçŸ¥]', time: '[æ—¶é—´]' }],
            },
          },
          lovesync: {
            controls: [
              { label: '[åŠŸèƒ½æŒ‰é’®1-å¦‚ç”µå‡»]', log: ['[æ“ä½œæ—¥å¿—1-ç”Ÿç†ååº”]', '[æ“ä½œæ—¥å¿—2-å¿ƒç†æå†™]'] },
              { label: '[åŠŸèƒ½æŒ‰é’®2-å¦‚éœ‡åŠ¨]', log: '[ç®¡é“ç¬¦æ ¼å¼æ—¥å¿—]|[å‚æ•°è¯¦æƒ…]|[æŒç»­æ—¶é—´]' },
            ],
            status: [
              { label: '[ç”Ÿç†æŒ‡æ ‡1-å¦‚å¿ƒç‡]', val: '[æ•°å€¼+çŠ¶æ€]', desc: '[å¯¹è‡ªå·±èº«ä½“ååº”çš„è‰²æ°”æè¿°]', color: 'red' },
              { label: '[ç”Ÿç†æŒ‡æ ‡2-å¦‚ç†æ™ºå€¼]', val: '[æ•°å€¼%]', desc: '[å¿ƒç†å´©æºƒ/æ¸´æœ›ç¨‹åº¦æè¿°]', color: 'purple' },
            ],
            diaries: [{ time: '[è®°å½•æ—¶é—´]', content: '[è§‚å¯Ÿæ—¥è®°-è®°å½•å·çª¥/æ½œå…¥/æ¥è§¦ç»å†]' }],
          },
          music: {
            recent: [{ t: '[æœ€è¿‘æ’­æ”¾æ­Œæ›²å]', artist: '[æ­Œæ‰‹]', cover: '[å°é¢é¢œè‰²:bg-red-900]' }],
            original: [
              {
                t: '[åŸåˆ›å½•éŸ³/æ­Œå]',
                desc: '[åˆ›ä½œåŠ¨æœºè¯´æ˜]',
                len: '[æ—¶é•¿]',
                lyrics: '[ç¬¬ä¸€å¥æ­Œè¯]<br>[ç¬¬äºŒå¥æ­Œè¯]<br>[å‰¯æ­Œéƒ¨åˆ†-éœ€é•¿ç¯‡å¹…æå†™]',
              },
            ],
          },
          game: [
            {
              name: '[æ¸¸æˆåç§°]',
              icon: '[å›¾æ ‡:box/users/skull]',
              color: '[é¢œè‰²]',
              reason: '[æ¸¸ç©åŠ¨æœº-å…³è”ç°å®æ§åˆ¶æ¬²]',
              review: '[æ¸¸ç©åæ„Ÿæƒ³-å½±å°„ä¸¤äººå…³ç³»]',
            },
          ],
          shopping: [
            { name: '[å•†å“åç§°-æ­£å¸¸æˆ–è¿ç¦å“]', desc: '[å¤‡æ³¨ç»†èŠ‚/ç”¨é€”æè¿°]', price: '[ä»·æ ¼]', status: '[ç‰©æµçŠ¶æ€]' },
          ],
          wardrobe: [
            {
              name: '[è¡£ç‰©åç§°]',
              icon: '[å›¾æ ‡:shirt/cat/layers]',
              rating: '[è¯„åˆ†æˆ–æ¨èæŒ‡æ•°]',
              comment: '[éœ²éª¨è¯„ä»·/ç©¿ç€ç¦ä»¤/æ€§å¹»æƒ³]',
              color: '[é¢œè‰²]',
            },
          ],
          memos: [
            { t: '[ä¾¿ç­¾æ ‡é¢˜]', c: '[ä¾¿ç­¾å†…å®¹-å®¶è§„/è®¡åˆ’/æ¢¦å¢ƒ]', rot: 'rotate-1' },
            { t: '[ä¾¿ç­¾æ ‡é¢˜2]', c: '[å†…å®¹]', rot: '-rotate-2' },
          ],
          files: {
            audio: {
              title: '[éŸ³é¢‘æ–‡ä»¶å¤¹å]',
              items: [{ name: '[æ–‡ä»¶å.mp3]', desc: '[å½•éŸ³æ¥æºåŠæ”¶å¬æ¬¡æ•°]', type: 'audio' }],
            },
            monitor: {
              title: '[ç›‘æ§æ–‡ä»¶å¤¹å]',
              items: [
                { name: '[ç›‘æ§ä½.mp4]', desc: '[ç›‘æ§ç”»é¢è¯¦ç»†æè¿°]', type: 'video' },
                { name: '[æ•…éšœè®¾å¤‡]', desc: '[ä¿¡å·ä¸¢å¤±æŠ¥é”™]', type: 'error' },
              ],
            },
            video: {
              title: '[è§†é¢‘æ–‡ä»¶å¤¹å]',
              items: [{ name: '[è§†é¢‘å.mp4]', desc: '[ç¬¬ä¸€äººç§°è§†è§’POVæè¿°]', type: 'video' }],
            },
            docs: {
              title: '[æ–‡æ¡£æ–‡ä»¶å¤¹å]',
              items: [{ name: '[æ–‡ä»¶å.xlsx]', desc: '[æ–‡æ¡£å†…å®¹æ‘˜è¦]', type: 'doc' }],
            },
          },
          gallery: [
            { type: 'public', t: '[å…¬å¼€ç…§ç‰‡æ ‡é¢˜]', d: '[æ­£å¸¸çº¦ä¼šåœºæ™¯æè¿°-ä½“ç°çˆ±æ„]' },
            { type: 'private', t: '[ç§å¯†ç…§ç‰‡æ ‡é¢˜]', d: '[å·æ‹/ç§å¯†éƒ¨ä½/ç¡çœ æ—¶çš„è¯¦ç»†è‰²æ°”æè¿°]' },
          ],
          browser: [
            {
              t: '[æœç´¢å…³é”®è¯/ç½‘é¡µæ ‡é¢˜]',
              site: '[æ¥æºç½‘ç«™-å¦‚æ·˜å®/æš—ç½‘]',
              noteTitle: '[ç¬”è®°æ ‡é¢˜]',
              noteContent: '[æµè§ˆåçš„å¿ƒç†æ´»åŠ¨/å­¦ä¹ å¿ƒå¾—/è®¡åˆ’]',
              color: 'blue',
            },
          ],
          anniversary: [{ date: '[æ—¥æœŸ]', title: '[çºªå¿µæ—¥åç§°]', desc: '[å½“æ—¶çš„æƒ…æ™¯å›å¿†]' }],
          moments: [
            { name: 'Boyfriend', time: '[å‘å¸ƒæ—¶é—´]', text: '[å…¬å¼€æ˜¾ç¤ºçš„ç”œèœœæˆ–æ­£å¸¸å†…å®¹]', lock: false },
            { name: 'Boyfriend', time: '[å‘å¸ƒæ—¶é—´]', text: '[ä»…è‡ªå·±å¯è§çš„ç—…å¨‡é»‘æ³¥/çœŸå®æƒ³æ³•]', lock: true },
          ],
          location: {
            points: [
              { x: 20, y: 80, type: 'past', name: '[åœ°ç‚¹A]', time: '[æ—¶é—´]', event: '[åœ¨è¯¥åœ°ç‚¹çš„è¡Œä¸ºæè¿°]' },
              { x: 75, y: 25, type: 'current', name: '[å½“å‰åœ°ç‚¹]', time: '[æ—¶é—´]', event: '[æ­£åœ¨è¿›è¡Œçš„è¡Œä¸º]' },
            ],
            targetText: '[å®šä½ç›®æ ‡çŠ¶æ€]',
          },
          tasks: {
            title: '[ä»»åŠ¡åˆ—è¡¨æ ‡é¢˜]',
            list: [
              { text: '[ä»»åŠ¡å†…å®¹1]', done: true },
              { text: '[ä»»åŠ¡å†…å®¹2]', done: false },
            ],
            reward: '[å®Œæˆå¥–åŠ±]',
          },
          gacha: {
            pool: [
              { type: 'SSR', text: '[å¤§å¥–å†…å®¹]', color: 'red' },
              { type: 'BAD', text: '[æƒ©ç½šå†…å®¹]', color: 'black' },
            ],
          },
          secret: {
            audios: [{ t: '[ç¢ç¢å¿µå½•éŸ³æ ‡é¢˜]', len: '[æ—¶é•¿]', desc: '[å½•éŸ³å†…å®¹-ç—…å¨‡ç‹¬ç™½]' }],
            photos: [{ t: '[å›¾ç‰‡æè¿°æ ‡é¢˜]', desc: '[æåº¦NSFWçš„ç”»é¢æè¿°/æ€§æš—ç¤º]' }],
            fantasies: [{ t: '[å‰§æœ¬æ ‡é¢˜]', c: '[å‰§æœ¬æ­£æ–‡-åŒ…å«åœºæ™¯/è§’è‰²/è¯¦ç»†å‰§æƒ…æ¨æ¼”]' }],
          },
          collection: [{ item: '[ç‰©å“åç§°-è´´èº«/åºŸå¼ƒç‰©]', date: '[æ”¶é›†æ—¥æœŸ]', desc: '[æ”¶é›†è¿‡ç¨‹åŠå¯¹ç€ç‰©å“åšçš„äº‹]' }],
        },
      };

      // ==========================================
      //               æ ¸å¿ƒæ¸²æŸ“é€»è¾‘
      // ==========================================

      function renderAll() {
        // System
        document.getElementById('carrier-text').innerText = filesData.system.carrier;
        document.getElementById('battery-text').innerText = filesData.system.battery;
        document.getElementById('ls-title').innerText = filesData.system.lockScreen.title;
        document.getElementById('ls-subtitle').innerText = filesData.system.lockScreen.subtitle;
        document.getElementById('ls-btn').innerText = filesData.system.lockScreen.button;
        document.getElementById('home-mood-text').innerText = filesData.system.home.mood;
        document.getElementById('settings-title').innerText = filesData.system.settings.errorText;

        // Location (è½¨è¿¹æ¸²æŸ“)
        const mapPoints = document.getElementById('map-points');
        const mapLines = document.getElementById('map-lines');
        const locLogs = document.getElementById('location-logs');
        const points = filesData.content.location.points;

        mapPoints.innerHTML = '';
        locLogs.innerHTML = '';

        // 1. ç”Ÿæˆ SVG è·¯å¾„å­—ç¬¦ä¸² (è¿æ¥æ‰€æœ‰ç‚¹)
        if (points.length > 1) {
          let pathD = `M ${points[0].x} ${points[0].y}`;
          for (let i = 1; i < points.length; i++) {
            pathD += ` L ${points[i].x} ${points[i].y}`;
          }
          mapLines.innerHTML = `<path d="${pathD}" stroke="#475569" stroke-width="2" fill="none" stroke-dasharray="4 4" vector-effect="non-scaling-stroke" />`;
          mapLines.setAttribute('viewBox', '0 0 100 100');
          mapLines.setAttribute('preserveAspectRatio', 'none');
        }

        // 2. æ¸²æŸ“ç‚¹å’Œæ—¥å¿—
        points.forEach((p, index) => {
          const isLast = index === points.length - 1;
          const pointColor = isLast ? 'red' : 'gray';
          const pulse = isLast ? '<div class="absolute -inset-2 bg-red-500/30 rounded-full animate-ping"></div>' : '';
          const icon = isLast ? 'map-pin' : 'circle'; // ç»ˆç‚¹ç”¨å›¾é’‰ï¼Œè·¯é€”ç”¨åœ†ç‚¹

          // åœ°å›¾ç‚¹
          mapPoints.innerHTML += `
                    <div class="absolute flex flex-col items-center" style="left: ${p.x}%; top: ${p.y}%; transform: translate(-50%, -50%);">
                        <div class="relative w-4 h-4 mb-1 flex items-center justify-center">
                            ${pulse}
                            <div class="w-3 h-3 bg-${pointColor}-500 rounded-full border border-white z-10 shadow-sm"></div>
                        </div>
                        <span class="text-[8px] text-white bg-black/50 px-1 rounded whitespace-nowrap backdrop-blur-sm border border-white/20">${p.name}</span>
                    </div>
                `;

          // åº•éƒ¨æ—¥å¿—
          const logIcon = isLast ? 'radio' : 'check-circle';
          const logColor = isLast ? 'text-red-400' : 'text-gray-500';
          const borderClass = isLast ? 'border-l-2 border-red-500 pl-2' : 'border-l border-gray-700 pl-2 ml-[1px]';

          locLogs.innerHTML += `
                    <div class="${borderClass} relative">
                        <div class="flex justify-between items-center text-xs mb-0.5">
                            <span class="${logColor} font-bold flex items-center gap-1">
                                <i data-lucide="${logIcon}" class="w-3 h-3"></i> ${p.name}
                            </span>
                            <span class="text-[9px] text-slate-500">${p.time}</span>
                        </div>
                        <p class="text-[10px] text-slate-300 leading-tight">${p.event}</p>
                    </div>
                `;
        });

        // App Grid
        const grid = document.getElementById('app-grid-container');
        grid.innerHTML = '';
        filesData.apps.forEach(app => {
          const colorClass = `bg-${app.color}-100`;
          const textClass = `text-${app.color}-600`;
          const iconColor = app.iconColor ? `text-${app.iconColor}` : textClass;
          grid.innerHTML += `<div class="app-item" onclick="openApp('${app.id}')"><div class="app-icon ${colorClass}"><i data-lucide="${app.icon}" class="${iconColor}"></i></div><span class="app-name">${app.name}</span></div>`;
        });

        // LoveSync
        const lsControls = document.getElementById('ls-controls-container');
        lsControls.innerHTML = '';
        filesData.content.lovesync.controls.forEach((btn, idx) => {
          // [ä¿®æ”¹] æ”¹ä¸ºè°ƒç”¨ lsLogControl å¹¶ä¼ å…¥åºå· idx
          lsControls.innerHTML += `<button onclick="lsLogControl(${idx})" class="bg-[#222] border border-pink-900 text-pink-500 p-2 text-xs rounded hover:bg-pink-900/30 transition active:scale-95">${btn.label}</button>`;
        });

        const lsStatus = document.getElementById('ls-status-container');
        lsStatus.innerHTML = '';
        filesData.content.lovesync.status.forEach(st => {
          lsStatus.innerHTML += `<div class="bg-[#111] border border-gray-800 p-3 rounded"><div class="flex justify-between text-xs text-gray-400 mb-1"><span>${
            st.label
          }</span><span class="text-${st.color}-500 ${
            st.color === 'red' || st.color === 'pink' ? 'animate-pulse' : ''
          }">${st.val}</span></div>${st.desc ? `<p class="text-[9px] text-gray-600 mt-1">${st.desc}</p>` : ''}</div>`;
        });

        const lsDiary = document.getElementById('ls-diary-container');
        lsDiary.innerHTML = '';
        filesData.content.lovesync.diaries.forEach(d => {
          lsDiary.innerHTML += `<div class="border border-gray-800 p-2"><div class="text-[9px] text-gray-500 mb-1">${d.time}</div><p class="text-[10px] text-gray-300">${d.content}</p></div>`;
        });

        // Shopping
        const shopList = document.getElementById('shopping-list');
        shopList.innerHTML = '';
        filesData.content.shopping.forEach(item => {
          shopList.innerHTML += `<div class="bg-white p-2 flex gap-2 border border-orange-200 shadow-sm"><div class="w-16 h-16 bg-gray-200 flex-center text-xs text-gray-400">å›¾ç‰‡</div><div class="flex-1 flex flex-col justify-between"><div class="text-xs font-bold text-slate-800">${item.name}</div><div class="text-[10px] text-gray-500">${item.desc}</div><div class="flex justify-between items-center"><span class="text-red-500 font-bold text-xs">${item.price}</span><button class="bg-orange-500 text-white px-2 py-0.5 text-[10px] rounded">${item.status}</button></div></div></div>`;
        });

        // Wardrobe
        const wdGrid = document.getElementById('wardrobe-grid');
        wdGrid.innerHTML = '';
        filesData.content.wardrobe.forEach((item, idx) => {
          wdGrid.innerHTML += `
                <div class="bg-white p-3 border-2 border-purple-200 rounded flex flex-col items-center cursor-pointer hover:border-purple-500 transition" 
                     onclick="openWardrobeItem(${idx})">
                    <i data-lucide="${item.icon}" class="w-10 h-10 text-${item.color}-400 mb-2"></i>
                    <span class="text-xs font-bold text-slate-700 text-center">${item.name}</span>
                    <span class="text-[9px] text-purple-500 mt-1">${item.rating}</span>
                </div>`;
        });

        // Memos
        const memoContainer = document.getElementById('memo-container');
        memoContainer.innerHTML = '';
        filesData.content.memos.forEach((m, i) => {
          memoContainer.innerHTML += `<div class="memo-paper ${m.rot}" onclick="showMemo(${i})"><div class="memo-tape"></div><div class="font-bold border-b border-gray-300 pb-1 mb-2 text-sm text-slate-800 tracking-wider">${m.t}</div><div class="text-slate-600 line-clamp-3 leading-tight text-xs">${m.c}</div></div>`;
        });

        // Gallery
        const galGrid = document.getElementById('gallery-grid');
        galGrid.innerHTML = '';

        // ====== æ–°å¢ï¼šå…¼å®¹ä»£ç å¼€å§‹ ======
        // ç›®çš„ï¼šåŒæ—¶æ”¯æŒæ—§ç‰ˆï¼ˆæ•°ç»„ï¼‰å’Œæ–°ç‰ˆæ³¨å…¥æ•°æ®ï¼ˆå¯¹è±¡åˆ†ç±»ï¼‰
        let galleryItems = [];

        if (Array.isArray(filesData.content.gallery)) {
          // æƒ…å†µAï¼šåŸå§‹é»˜è®¤æ•°æ®æ˜¯æ•°ç»„
          galleryItems = filesData.content.gallery;
        } else if (filesData.content.gallery && typeof filesData.content.gallery === 'object') {
          // æƒ…å†µBï¼šæ³¨å…¥çš„æ•°æ®æ˜¯å¯¹è±¡ (åŒ…å« public å’Œ private)
          // æ‰‹åŠ¨å°†å®ƒä»¬åˆå¹¶æˆæ•°ç»„ï¼Œå¹¶è¡¥ä¸Š type å±æ€§
          if (filesData.content.gallery.public) {
            filesData.content.gallery.public.forEach(item => {
              galleryItems.push({ ...item, type: 'public' });
            });
          }
          if (filesData.content.gallery.private) {
            filesData.content.gallery.private.forEach(item => {
              galleryItems.push({ ...item, type: 'private' });
            });
          }
        }
        // ====== æ–°å¢ï¼šå…¼å®¹ä»£ç ç»“æŸ ======

        // æ³¨æ„ï¼šä¸‹é¢è¿™é‡Œè¦æŠŠåŸæ¥çš„ filesData.content.gallery.forEach æ”¹æˆ galleryItems.forEach
        galleryItems.forEach(img => {
          if (img.type === 'private') {
            galGrid.innerHTML += `<div class="aspect-square bg-pink-100 border-2 border-pink-400 flex-center cursor-pointer relative overflow-hidden group" onclick="decryptImg(this, '${img.t}', '${img.d}')"><div class="absolute inset-0 flex-center flex-col text-pink-700 bg-pink-100 z-10 transition-transform duration-300"><i data-lucide="lock" class="w-5 h-5 mb-1"></i></div><div class="w-full h-full bg-slate-800 flex-center"><span class="text-[8px] text-white">DECRYPTED</span></div></div>`;
          } else {
            galGrid.innerHTML += `<div class="aspect-square bg-gray-200 border border-gray-300 flex-center cursor-pointer hover:opacity-80" onclick="showLightbox('${img.t}', '${img.d}')"><i data-lucide="image" class="w-5 h-5 text-gray-400"></i></div>`;
          }
        });

        // Browser
        const browserHist = document.getElementById('browser-history');
        browserHist.innerHTML = '';
        filesData.content.browser.forEach((b, index) => {
          const color = b.color || 'pink';

          // ====== ä¿®æ”¹ç‚¹ï¼šå¢åŠ  site çš„é»˜è®¤å€¼å…¼å®¹ ======
          // å¦‚æœæ•°æ®é‡Œæ²¡æœ‰ site å­—æ®µï¼Œå°±ç”¨ 'Unkown' ä»£æ›¿ï¼Œé˜²æ­¢ .trim() æŠ¥é”™
          const siteText = b.site || 'Unknown';
          const iconText = siteText.trim().charAt(0).toUpperCase();
          // ==========================================

          browserHist.innerHTML += `
                  <div class="flex gap-2 cursor-pointer hover:bg-gray-100 p-1 rounded transition" onclick="openBrowserNote(${index})">
                    <div class="w-8 h-8 bg-${color}-100 rounded flex items-center justify-center text-${color}-500 font-bold text-xs flex-shrink-0">
                        ${iconText}
                    </div>
                    <div class="min-w-0 flex-1">
                      <div class="text-xs font-bold text-${color === 'pink' ? 'blue' : color}-600 truncate">${b.t}</div>
                      <div class="text-[10px] text-gray-400 truncate">${siteText}</div>
                    </div>
                  </div>
                `;
        });
        // Anniversary
        const annList = document.getElementById('anniversary-list');
        annList.innerHTML = '';
        filesData.content.anniversary.forEach(ann => {
          annList.innerHTML += `
                <div class="bg-white border-2 border-[#fda4af] p-3 shadow-[4px_4px_0_0_rgba(251,113,133,0.5)] relative">
                    <div class="absolute -top-3 left-2 bg-[#be123c] text-white text-[10px] px-2 py-0.5 font-bold rounded">
                        ${ann.date}
                    </div>
                    <div class="mt-2">
                        <h3 class="text-sm font-bold text-[#881337] mb-1">${ann.title}</h3>
                        <p class="text-[10px] text-gray-600 leading-tight font-mono border-t border-dashed border-red-200 pt-1">
                            ${ann.desc}
                        </p>
                    </div>
                    <i data-lucide="heart" class="w-4 h-4 text-red-400 absolute bottom-2 right-2 opacity-20"></i>
                </div>
            `;
        });

        // Messages List
        const msgList = document.getElementById('msg-list');
        msgList.innerHTML = '';
        filesData.content.messages.list.forEach(c => {
          msgList.innerHTML += `<div class="bg-white p-3 border-b border-gray-100 flex gap-3 hover:bg-gray-50 cursor-pointer" onclick="openChat('${
            c.id
          }', '${c.name}')"><div class="w-10 h-10 rounded-lg bg-gradient-to-br ${
            c.top ? 'from-green-400 to-green-600' : 'from-gray-400 to-gray-600'
          } text-white flex-center font-bold text-sm shadow-sm">${
            c.name[0]
          }</div><div class="flex-1 min-w-0"><div class="flex justify-between items-baseline mb-1"><span class="font-bold text-slate-800 text-xs truncate">${
            c.name
          }</span><span class="text-[10px] text-gray-400">${
            c.time
          }</span></div><p class="text-[10px] text-gray-500 truncate">${c.msg}</p></div></div>`;
        });

        // Moments
        const momList = document.getElementById('moments-list');
        momList.innerHTML = '';
        filesData.content.moments.forEach(m => {
          let content = m.lock
            ? `<div class="w-full h-32 bg-black flex-center cursor-pointer relative group" onclick="this.querySelector('.absolute').style.opacity='0'"><div class="absolute inset-0 flex-center flex-col text-red-500 z-10 transition-opacity duration-500 bg-black"><i data-lucide="eye-off" class="w-6 h-6 mb-1"></i><span class="text-[10px] font-bold">æ•æ„Ÿå†…å®¹ / ç‚¹å‡»è§£å¯†</span></div><div class="text-white text-xs opacity-50">( ${m.text} )</div></div>`
            : `<p class="text-xs text-slate-800 mb-2">${m.text}</p>`;
          momList.innerHTML += `<div class="bg-white p-4 mb-2 border-b border-gray-100"><div class="flex gap-2 mb-2"><div class="w-8 h-8 bg-slate-800 rounded flex-center text-white font-bold text-xs">â™¡</div><div><div class="font-bold text-xs text-blue-900">${m.name}</div><div class="text-[10px] text-gray-400">${m.time}</div></div></div>${content}</div>`;
        });

        // Files Folders
        const fileFolders = document.getElementById('file-folders');
        fileFolders.innerHTML = '';
        Object.keys(filesData.content.files).forEach(key => {
          const folder = filesData.content.files[key];
          let icon = 'folder';
          let color = 'blue';
          if (key === 'audio') {
            icon = 'mic';
            color = 'blue';
          }
          if (key === 'monitor') {
            icon = 'cctv';
            color = 'red';
          }
          if (key === 'video') {
            icon = 'film';
            color = 'purple';
          }
          if (key === 'docs') {
            icon = 'file-text';
            color = 'yellow';
          }

          fileFolders.innerHTML += `
                 <div class="bg-white p-3 rounded-lg shadow-sm border border-gray-200 flex flex-col items-center gap-2 cursor-pointer active:scale-95 transition" onclick="openFolder('${key}')">
                    <div class="w-12 h-12 bg-${color}-100 rounded-lg flex-center text-${color}-500"><i data-lucide="${icon}" class="w-6 h-6"></i></div>
                    <span class="text-xs font-bold text-slate-700">${folder.title}</span>
                    <span class="text-[9px] text-gray-400">${folder.items.length} items</span>
                </div>`;
        });

        // Tasks
        const taskList = document.getElementById('task-list');
        taskList.innerHTML = '';
        let doneCount = 0;
        filesData.content.tasks.list.forEach((t, i) => {
          if (t.done) doneCount++;
          const icon = t.done ? 'check-square' : 'square';
          const style = t.done ? 'text-teal-600 line-through opacity-60 bg-teal-50' : 'text-slate-700 bg-white';

          taskList.innerHTML += `
                <div class="flex items-center gap-3 p-3 border border-teal-200 cursor-pointer hover:bg-teal-50 transition ${style}" onclick="toggleTask(${i})">
                    <i data-lucide="${icon}" class="w-5 h-5 flex-shrink-0"></i>
                    <span class="text-xs font-bold">${t.text}</span>
                </div>`;
        });
        const percent = Math.round((doneCount / filesData.content.tasks.list.length) * 100);
        document.getElementById('task-bar').style.width = `${percent}%`;
        document.getElementById('task-percent').innerText = `${percent}%`;
        if (percent === 100) {
          document.getElementById('task-reward').classList.remove('hidden');
          document.getElementById('task-reward-text').innerText = filesData.content.tasks.reward;
        } else {
          document.getElementById('task-reward').classList.add('hidden');
        }

        // Music
        const musicCont = document.getElementById('music-container');
        if (musicCont && filesData.content.music) {
          musicCont.innerHTML = `
                <!-- åŸåˆ›åŒº -->
                <div>
                    <h3 class="text-xs font-bold text-rose-400 mb-2 border-l-2 border-rose-500 pl-2">MY ORIGINALS (FOR YOU)</h3>
                    <div class="space-y-2">
                        ${filesData.content.music.original
                          .map(
                            (s, idx) => `
                            <div class="bg-[#222] p-2 rounded border border-rose-900/50 flex gap-3 items-center group cursor-pointer hover:bg-[#333] transition" onclick="openMusicTicket(${idx})">
                                <div class="w-8 h-8 bg-rose-900 rounded flex-center text-rose-300 group-hover:scale-110 transition"><i data-lucide="mic"></i></div>
                                <div class="flex-1 min-w-0">
                                    <div class="text-xs font-bold text-gray-200 truncate">${s.t}</div>
                                    <div class="text-[9px] text-gray-500 truncate">${s.desc}</div>
                                </div>
                                <div class="text-[9px] text-rose-700 font-mono">${s.len}</div>
                            </div>
                        `,
                          )
                          .join('')}
                    </div>
                </div>
                
                <!-- æœ€è¿‘åœ¨å¬ -->
                <div>
                    <h3 class="text-xs font-bold text-gray-500 mb-2 border-l-2 border-gray-600 pl-2">RECENTLY PLAYED</h3>
                    <div class="space-y-2">
                        ${filesData.content.music.recent
                          .map(
                            s => `
                            <div class="flex gap-3 items-center opacity-70 hover:opacity-100 transition cursor-pointer">
                                <div class="w-8 h-8 ${s.cover} rounded flex-center text-white/50 text-[8px] font-bold">CD</div>
                                <div class="flex-1 border-b border-gray-800 pb-2">
                                    <div class="text-xs text-gray-300">${s.t}</div>
                                    <div class="text-[9px] text-gray-600">${s.artist}</div>
                                </div>
                            </div>
                        `,
                          )
                          .join('')}
                    </div>
                </div>
            `;
        }

        // Game
        const gameList = document.getElementById('game-list');
        gameList.innerHTML = '';
        filesData.content.game.forEach((g, idx) => {
          gameList.innerHTML += `
                <div class="bg-white border-2 border-${g.color}-500 p-2 flex gap-3 items-center shadow-sm cursor-pointer active:translate-y-1 transition" onclick="openGameDetail(${idx})">
                    <div class="w-12 h-12 bg-${g.color}-100 border border-${g.color}-200 flex-center text-${g.color}-600">
                        <i data-lucide="${g.icon}" class="w-6 h-6"></i>
                    </div>
                    <div class="flex-1">
                        <div class="font-bold text-xs text-slate-800">${g.name}</div>
                        <div class="text-[9px] text-slate-500 mt-1 bg-slate-100 inline-block px-1 rounded">ç‚¹å‡»æŸ¥çœ‹è¯„ä»·</div>
                    </div>
                    <i data-lucide="chevron-right" class="w-4 h-4 text-gray-300"></i>
                </div>
            `;
        });

        // Collection
        const colGrid = document.getElementById('collection-grid');
        colGrid.innerHTML = '';
        filesData.content.collection.forEach((item, idx) => {
          colGrid.innerHTML += `
                <div class="bg-[#27272a] border border-gray-600 p-2 flex flex-col gap-2 relative overflow-hidden group cursor-pointer hover:border-gray-400 transition" onclick="openCollectionModal(${idx})">
                    <div class="absolute top-0 right-0 bg-gray-700 text-[8px] px-1 text-gray-400">${item.date}</div>
                    <div class="h-12 bg-black/50 flex-center border border-dashed border-gray-700 mt-2">
                        <i data-lucide="package" class="text-gray-500 group-hover:text-gray-300 transition"></i>
                    </div>
                    <div class="text-xs font-bold text-gray-200 truncate">${item.item}</div>
                </div>
            `;
        });

        renderSecretContent('audio');

        // ã€ä¿®å¤ã€‘åŠ å®‰å…¨åˆ¤æ–­ï¼Œé˜²æ­¢æŠ¥é”™ä¸­æ–­æ¸²æŸ“
        if (typeof lucide !== 'undefined') {
          lucide.createIcons();
        } else {
          console.warn('Lucide icon library not loaded.');
        }
      }
      // ==========================================
      //      å¼ºåŠ›æ¸…æ´—ä¸å®šä½ç³»ç»Ÿ (Deep Clean)
      // ==========================================

      const DATA_REGEX = /<BOYFRIEND_DATA>([\s\S]*?)<\/BOYFRIEND_DATA>/;
      // ==========================================
      //      ç»ˆææ ¼å¼åŒ–ï¼šå«æ™ºèƒ½å¼•å·ä¿®å¤åŠŸèƒ½
      // ==========================================
      function formatJSONString(text) {
        // 1. åŸºç¡€æ¸…æ´—
        let cleanText = text.replace(/\u00A0/g, ' ').replace(/\u3000/g, ' ');

        // 2. ä¿®å¤ä¸­æ–‡æ ‡ç‚¹ (å¼•å·ã€é€—å·ã€å†’å·)
        cleanText = cleanText.replace(/â€œ|â€/g, '"').replace(/ï¼Œ/g, ',').replace(/ï¼š/g, ':');

        // 3. å»é™¤å†—ä½™ä¸­æ‹¬å·
        cleanText = cleanText.replace(/"\[(.*?)\]"/g, '"$1"');

        // åˆ†ç¦»æ ‡ç­¾
        let jsonContent = cleanText;
        let header = '';
        let footer = '';

        const tagMatch = cleanText.match(/(<BOYFRIEND_DATA>)([\s\S]*?)(<\/BOYFRIEND_DATA>)/);
        if (tagMatch) {
          header = tagMatch[1] + '\n';
          jsonContent = tagMatch[2];
          footer = '\n' + tagMatch[3];
        } else if (cleanText.includes('<BOYFRIEND_DATA>')) {
          header = '<BOYFRIEND_DATA>\n';
          jsonContent = cleanText.replace('<BOYFRIEND_DATA>', '').replace('</BOYFRIEND_DATA>', '');
        }

        // 4. æ™ºèƒ½é‡æ’ç‰ˆ (å«åµŒå¥—å¼•å·ä¿®å¤)
        let formatted = '';
        let indentLevel = 0;
        const indentStr = '  ';
        let inString = false;
        let isEscaped = false;

        jsonContent = jsonContent.trim();

        for (let i = 0; i < jsonContent.length; i++) {
          const char = jsonContent[i];

          // --- å­—ç¬¦ä¸²å†…éƒ¨é€»è¾‘ ---
          if (inString) {
            if (char === '\\' && !isEscaped) {
              isEscaped = true;
              formatted += char;
            } else if (char === '"' && !isEscaped) {
              // [å…³é”®ä¿®å¤é€»è¾‘]ï¼šæ£€æµ‹è¿™æ˜¯ä¸æ˜¯"å‡"å¼•å·
              // å¾€åçœ‹ï¼Œè·³è¿‡ç©ºæ ¼ï¼Œæ‰¾ä¸‹ä¸€ä¸ªæœ‰æ•ˆå­—ç¬¦
              let nextIdx = i + 1;
              while (nextIdx < jsonContent.length && /\s/.test(jsonContent[nextIdx])) {
                nextIdx++;
              }
              const nextChar = jsonContent[nextIdx];

              // JSON ç»“æ„ä¸­ï¼Œåˆæ³•çš„ç»“æŸå¼•å·åé¢åªèƒ½è·Ÿï¼šé€—å·, å†’å·:, ç»“æŸæ‹¬å·}, ç»“æŸæ•°ç»„]
              // å¦‚æœåé¢æ˜¯å…¶ä»–ä¸œè¥¿ï¼ˆæ¯”å¦‚å¥å·ã€æ–‡å­—ï¼‰ï¼Œè¯´æ˜è¿™ä¸ªå¼•å·æ˜¯å†…å®¹çš„ä¸€éƒ¨åˆ†ï¼
              const isRealEnd = [',', ':', '}', ']'].includes(nextChar);

              if (!isRealEnd) {
                // å‘ç°å‡å¼•å·ï¼è‡ªåŠ¨å¸®å®ƒè½¬ä¹‰ï¼Œé˜²æ­¢æ ¼å¼é”™ä¹±
                formatted += '\\"';
                // æ³¨æ„ï¼šinString ä¾ç„¶æ˜¯ trueï¼Œå› ä¸ºè¿˜æ²¡çœŸçš„ç»“æŸ
              } else {
                // æ˜¯çœŸå¼•å·ï¼Œæ­£å¸¸ç»“æŸ
                inString = false;
                formatted += char;
              }
            } else {
              isEscaped = false;
              formatted += char;
            }
            continue;
          }

          // --- å­—ç¬¦ä¸²å¤–éƒ¨é€»è¾‘ ---
          if (/\s/.test(char)) continue; // æ€æ‰ç©ºè¡Œ

          if (char === '"') {
            inString = true;
            formatted += char;
          } else if (char === '{' || char === '[') {
            formatted += char + '\n';
            indentLevel++;
            formatted += indentStr.repeat(indentLevel);
          } else if (char === '}' || char === ']') {
            formatted += '\n';
            indentLevel = Math.max(0, indentLevel - 1);
            formatted += indentStr.repeat(indentLevel);
            formatted += char;
          } else if (char === ',') {
            formatted += char + '\n';
            formatted += indentStr.repeat(indentLevel);
          } else if (char === ':') {
            formatted += ': ';
          } else {
            formatted += char;
          }
        }
        return header + formatted + footer;
      }

      // --- æ ¸å¿ƒ 2: [æ–°å¢] è¿˜åŸ/å‹ç¼© (Compress) ---
      window.compressDebugInput = function () {
        const input = document.getElementById('debug-input');
        if (!input.value.trim()) return;

        // å¤ç”¨æ ¼å¼åŒ–é‡Œçš„æ¸…æ´—é€»è¾‘ï¼ˆä¿®æ ‡ç‚¹ã€å»æ‹¬å·ç­‰ï¼‰ï¼Œä¿è¯å‹ç¼©åçš„ä¹Ÿæ˜¯â€œå¹²å‡€â€çš„
        let text = input.value;
        text = text
          .replace(/\u00A0/g, ' ')
          .replace(/â€œ|â€/g, '"')
          .replace(/ï¼Œ/g, ',')
          .replace(/ï¼š/g, ':');
        text = text.replace(/"\[(.*?)\]"/g, '"$1"');

        // åˆ†ç¦»æ ‡ç­¾
        let header = '';
        let footer = '';
        let jsonContent = text;

        const tagMatch = text.match(/(<BOYFRIEND_DATA>)([\s\S]*?)(<\/BOYFRIEND_DATA>)/);
        if (tagMatch) {
          header = tagMatch[1]; // å‹ç¼©æ—¶ä¸åŠ æ¢è¡Œ
          jsonContent = tagMatch[2];
          footer = tagMatch[3];
        }

        // å‹ç¼©é€»è¾‘ï¼šåªä¿ç•™å­—ç¬¦ä¸²å†…çš„ç©ºæ ¼ï¼Œç§»é™¤ç»“æ„ä¸Šçš„ç©ºæ ¼å’Œæ¢è¡Œ
        let compressed = '';
        let inString = false;
        let isEscaped = false;

        for (let i = 0; i < jsonContent.length; i++) {
          const char = jsonContent[i];
          if (inString) {
            if (char === '\\' && !isEscaped) {
              isEscaped = true;
              compressed += char;
            } else if (char === '"' && !isEscaped) {
              inString = false;
              compressed += char;
            } else {
              isEscaped = false;
              compressed += char;
            }
            continue;
          }
          // å¦‚æœä¸åœ¨å­—ç¬¦ä¸²é‡Œï¼Œå¿½ç•¥æ‰€æœ‰ç©ºç™½ç¬¦
          if (/\s/.test(char)) continue;

          compressed += char;
        }

        input.value = header + compressed + footer;

        const status = document.getElementById('debug-status');
        if (status) {
          status.style.color = '#d97706'; // Amber color
          status.innerText = 'INFO: å·²è¿˜åŸå‹ç¼©ä¸ºå•è¡Œ';
        }
      };

      // ç»‘å®šç»™æ ¼å¼åŒ–æŒ‰é’®
      window.formatDebugInput = function () {
        const input = document.getElementById('debug-input');
        input.value = formatJSONString(input.value);
        const status = document.getElementById('debug-status');
        if (status) {
          status.style.color = '#60a5fa';
          status.innerText = 'INFO: å·²æ ¼å¼åŒ– (ä¸­æ–‡æ ‡ç‚¹å·²ä¿®å¤)';
        }
      };

      // --- æ ¸å¿ƒ 2: è§†è§‰å®šä½ (æ»šåŠ¨ + é«˜äº®) ---
      function jumpToErrorLine(position) {
        const textarea = document.getElementById('debug-input');
        const text = textarea.value;

        // æ‰¾åˆ°è¡Œé¦–å’Œè¡Œå°¾
        const start = text.lastIndexOf('\n', position - 1) + 1;
        let end = text.indexOf('\n', position);
        if (end === -1) end = text.length;

        // ç®—å‡ºæ˜¯ç¬¬å‡ è¡Œ
        const lineNum = text.substring(0, start).split('\n').length;

        textarea.focus();
        textarea.setSelectionRange(start, end);

        // æ»šåŠ¨é€»è¾‘ï¼šæ¯è¡Œå¤§çº¦ 14-20pxï¼Œæ ¹æ®è¡Œå·ä¼°ç®—é«˜åº¦
        const lineHeight = 16;
        const scrollPos = lineNum * lineHeight - 100; // -100 æ˜¯ä¸ºäº†è®©é”™è¯¯è¡Œåœ¨å±å¹•ä¸­é—´åä¸Š
        textarea.scrollTop = scrollPos > 0 ? scrollPos : 0;
      }

      // --- æ ¸å¿ƒ 3: å †æ ˆæ£€æŸ¥ ---
      function checkBalance(jsonStr) {
        let stack = [];
        let inString = false;
        let isEscaped = false;

        for (let i = 0; i < jsonStr.length; i++) {
          const char = jsonStr[i];
          if (char === '<') continue; // è·³è¿‡ tag

          if (inString) {
            if (char === '\\' && !isEscaped) isEscaped = true;
            else {
              if (char === '"' && !isEscaped) inString = false;
              isEscaped = false;
            }
            continue;
          }
          if (char === '"') {
            inString = true;
            continue;
          }

          if (char === '{' || char === '[') {
            stack.push({ char, pos: i });
          } else if (char === '}' || char === ']') {
            if (stack.length === 0) {
              return {
                valid: false,
                pos: i,
                msg: `è‡´å‘½é”™è¯¯ï¼šåœ¨æ­¤å¤„ '${char}' ä¹‹å‰ï¼Œæ‰€æœ‰æ‹¬å·å·²é—­åˆã€‚\nç³»ç»Ÿè®¤ä¸º JSON å·²ç»“æŸï¼Œä½†åé¢è¿˜æœ‰å†…å®¹ã€‚\nå¯èƒ½åŸå› ï¼šè¿™ä¹‹å‰çš„æŸä¸ªå¤§æ‹¬å·å¤šå†™äº†ï¼Œå¯¼è‡´æå‰ç»“æŸã€‚`,
              };
            }
            const last = stack.pop();
            const expected = last.char === '{' ? '}' : ']';
            if (char !== expected) {
              return { valid: false, pos: i, msg: `æ‹¬å·ä¸åŒ¹é…ï¼šæœŸæœ› '${expected}' ä½†å‘ç°äº† '${char}'` };
            }
          }
        }
        if (stack.length > 0) {
          const last = stack[stack.length - 1];
          return { valid: false, pos: last.pos, msg: `é”™è¯¯ï¼šè¿™é‡Œå¼€å¯çš„ '${last.char}' ç›´åˆ°æœ€åéƒ½æ²¡æœ‰é—­åˆã€‚` };
        }
        return { valid: true };
      }

      // --- ä¸»å…¥å£ ---
      window.updatePhoneData = function (aiText) {
        const inputEl = document.getElementById('debug-input');
        const status = document.getElementById('debug-status');

        // 1. ä¼˜å…ˆä½¿ç”¨è¾“å…¥æ¡†å†…å®¹ï¼Œå¹¶æ‰§è¡Œã€å¼ºåŠ›æ¸…æ´—ã€‘
        let rawText = inputEl.value.trim() || aiText;
        const formattedText = formatJSONString(rawText);

        // å›å¡«æ¸…æ´—åçš„ä»£ç 
        inputEl.value = formattedText;

        // 2. æå– JSON
        let jsonStr = '';
        const match = formattedText.match(DATA_REGEX);
        if (match && match[1]) {
          jsonStr = match[1];
        } else {
          jsonStr = formattedText;
        }

        // äºŒæ¬¡æ¸…æ´—å¼•å·
        jsonStr = jsonStr.replace(/[\u201C\u201D]/g, '"');

        // 3. å°è¯•è§£æ
        try {
          const newData = JSON.parse(jsonStr);

          // æ³¨å…¥æ•°æ®
          if (newData.system) filesData.system = Object.assign({}, filesData.system, newData.system);
          if (newData.apps) filesData.apps = newData.apps;
          if (newData.content) {
            Object.keys(newData.content).forEach(k => (filesData.content[k] = newData.content[k]));
          }
          init(); // é‡æ–°æ¸²æŸ“é¡µé¢

          if (status) {
            status.style.color = '#4ade80';
            status.innerText = 'SUCCESS: æ³¨å…¥æˆåŠŸw(â—â€²Ë˜â€µâ—)';
          }
          setTimeout(() => document.getElementById('debug-modal').classList.add('hidden'), 1000);
          return;
        } catch (e) {
          console.error(e);
          // 4. è§£æå¤±è´¥ï¼Œå¼€å§‹å®šä½
          const diag = checkBalance(formattedText);

          if (!diag.valid) {
            jumpToErrorLine(diag.pos);
            if (status) {
              status.style.color = '#f87171';
              status.innerText = `ERROR: ç»“æ„é”™è¯¯ (å·²å®šä½)`;
            }
            alert(`ã€æ ¼å¼é”™è¯¯ã€‘\n\n${diag.msg}\n\nå·²è‡ªåŠ¨é€‰ä¸­é”™è¯¯è¡Œï¼Œè¯·ç›´æ¥ä¿®æ”¹ã€‚`);
          } else {
            // å¦‚æœç»“æ„æ²¡é—®é¢˜ï¼Œé€šå¸¸æ˜¯é€—å·é—®é¢˜
            const posMatch = e.message.match(/position (\d+)/);
            if (posMatch) {
              const errorPos = parseInt(posMatch[1]);
              // ä¼°ç®—ä½ç½®
              const tagIndex = formattedText.indexOf('<BOYFRIEND_DATA>');
              const startOffset = tagIndex === -1 ? 0 : tagIndex + 16;

              jumpToErrorLine(startOffset + errorPos);
              alert(`ã€è¯­æ³•é”™è¯¯ã€‘\nè™½ç„¶æ‹¬å·æ˜¯å¯¹çš„ï¼Œä½†å¯èƒ½æœ‰æ ‡ç‚¹é”™è¯¯ï¼ˆå¦‚å°‘å†™äº†é€—å·ï¼‰ã€‚\n\nå·²å®šä½åˆ°æŠ¥é”™ä½ç½®é™„è¿‘ã€‚`);
            } else {
              alert(`ã€é”™è¯¯ã€‘${e.message}`);
            }
          }
        }
      };

      // ç»‘å®šç»™æ ¼å¼åŒ–æŒ‰é’®
      window.formatDebugInput = function () {
        const input = document.getElementById('debug-input');
        input.value = formatJSONString(input.value);
      };

      // Helper function to be called from the debug input
      function parseAndInject(text) {
        window.updatePhoneData(text);
      }

      // ==========================================
      //               äº¤äº’é€»è¾‘ (Interaction)
      // ==========================================

      function init() {
        renderAll();
        lucide.createIcons();
      }

      function openGameDetail(idx) {
        const g = filesData.content.game[idx];
        document.getElementById('gm-name').innerText = g.name;
        document.getElementById('gm-reason').innerText = g.reason;
        document.getElementById('gm-review').innerText = g.review;
        const modal = document.getElementById('game-modal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
      }

      function openMusicTicket(idx) {
        const song = filesData.content.music.original[idx];
        document.getElementById('mt-title').innerText = song.t;
        document.getElementById('mt-desc').innerText = song.desc;
        document.getElementById('mt-lyrics').innerHTML = song.lyrics;
        const modal = document.getElementById('music-ticket-modal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
      }

      let currentSecretTab = 'audio';
      // å°† switchLsTab å’Œ renderSecretContent ç§»åˆ°å…¨å±€ä½œç”¨åŸŸ
      function switchSecretTab(tab) {
        currentSecretTab = tab;
        renderSecretContent(tab);
      }
      // [ä¿®æ”¹] å¾ªç¯ Log æ§åˆ¶å‡½æ•° (ä¼˜åŒ–ï¼šä»…æœ€æ–°ä¸€æ¡é—ªçƒ)
      function lsLogControl(idx) {
        const control = filesData.content.lovesync.controls[idx];
        const logsContainer = document.getElementById('ls-logs');

        if (!logsContainer) return;

        // 1. å…³é”®æ­¥éª¤ï¼šæ‰¾åˆ°å½“å‰çš„ç¬¬ä¸€æ¡æ—¥å¿—ï¼ˆä¹Ÿå°±æ˜¯ä¸Šä¸€æ¡ï¼‰ï¼Œç§»é™¤å®ƒçš„é—ªçƒç±»å
        const lastLog = logsContainer.firstElementChild;
        if (lastLog) {
          lastLog.classList.remove('animate-pulse');
          // å¯é€‰ï¼šä½ ç”šè‡³å¯ä»¥æŠŠæ—§æ—¥å¿—å˜æš—ä¸€ç‚¹ï¼Œå¢åŠ å±‚æ¬¡æ„Ÿ
          // lastLog.classList.replace('text-green-500', 'text-green-800');
        }

        // 2. å‡†å¤‡æ–°æ•°æ®
        let logs = [];
        if (Array.isArray(control.log)) {
          logs = control.log;
        } else {
          logs = control.log.split('|');
        }

        if (typeof control.counter === 'undefined') control.counter = 0;
        const currentMsg = logs[control.counter];

        // 3. åˆ›å»ºæ–°å…ƒç´  (è€Œä¸æ˜¯æ‹¼æ¥å­—ç¬¦ä¸²)
        const p = document.createElement('p');
        p.className = 'text-green-500 animate-pulse'; // åªç»™è¿™ä¸€æ¡åŠ é—ªçƒ
        p.innerText = `> ${currentMsg}`;

        // 4. æ’å…¥åˆ°å®¹å™¨æœ€å‰é¢
        logsContainer.prepend(p);

        // 5. æ›´æ–°è®¡æ•°å™¨
        control.counter = (control.counter + 1) % logs.length;
      }

      function switchLsTab(tabName) {
        // æ›´æ–° Tab æ ·å¼
        const tabs = document.querySelectorAll('.ls-tab');
        if (tabs) {
          tabs.forEach(tab => {
            const target = tab.getAttribute('data-target');
            if (target === tabName) {
              tab.classList.add('active');
            } else {
              tab.classList.remove('active');
            }
          });
        }

        // åˆ‡æ¢å†…å®¹æ˜¾ç¤º
        const ids = ['ls-view-control', 'ls-view-status', 'ls-view-diary'];
        ids.forEach(id => {
          const el = document.getElementById(id);
          if (el) el.classList.add('hidden');
        });

        const targetEl = document.getElementById('ls-view-' + tabName);
        if (targetEl) targetEl.classList.remove('hidden');
      }
      // [ä¿®æ”¹] æ”¯æŒå¤šè¡Œ Log çš„è¾“å‡ºå‡½æ•°
      function lsLog(msg) {
        const logs = document.getElementById('ls-logs');
        if (logs) {
          // æŒ‰ç…§ | åˆ†å‰²å†…å®¹ï¼Œæ”¯æŒå¤šæ¡åŒæ—¶å‘é€
          const lines = msg.split('|');
          lines.forEach(line => {
            logs.innerHTML = `<p class="text-green-500">> ${line}</p>` + logs.innerHTML;
          });
        }
      }

      function showMemo(idx) {
        const m = filesData.content.memos[idx];
        document.getElementById('memo-modal-title').innerText = m.t;
        document.getElementById('memo-modal-content').innerText = m.c;
        document.getElementById('memo-modal').classList.remove('hidden');
        document.getElementById('memo-modal').classList.add('flex');
      }
      function showLightbox(t, d) {
        document.getElementById('lb-title').innerText = t;
        document.getElementById('lb-desc').innerText = d;
        document.getElementById('lightbox').classList.remove('hidden');
        document.getElementById('lightbox').classList.add('flex');
      }

      function renderSecretContent(tab) {
        const container = document.getElementById('secret-content');
        // é˜²æ­¢æ•´ä¸ª secret å¯¹è±¡ä¸å­˜åœ¨
        const data = filesData.content.secret || {};
        container.innerHTML = '';

        if (tab === 'audio') {
          // ã€å…³é”®ä¿®æ”¹ã€‘(data.audios || [])
          // æ„æ€æ˜¯ï¼šå¦‚æœ data.audios ä¸å­˜åœ¨ï¼Œå°±ç”¨ç©ºæ•°ç»„ [] ä»£æ›¿ï¼Œé˜²æ­¢æŠ¥é”™
          (data.audios || []).forEach((a, idx) => {
            container.innerHTML += `
                      <div class="bg-[#2a0a0a] border border-red-900/60 p-3 rounded flex items-center gap-3 cursor-pointer hover:border-red-600 transition" 
                           onclick="openSecretModal('audio', ${idx})">
                          <div class="w-10 h-10 bg-red-900/20 rounded-full flex-center border border-red-800 text-red-500 animate-pulse">
                              <i data-lucide="mic"></i>
                          </div>
                          <div class="flex-1">
                              <div class="text-xs font-bold text-red-400">${a.t}</div>
                              <div class="text-[9px] text-red-800 font-mono">${a.len || 'Unknown'}</div>
                          </div>
                          <i data-lucide="play" class="w-4 h-4 text-red-700"></i>
                      </div>`;
          });
        } else if (tab === 'photo') {
          container.className = 'grid grid-cols-2 gap-3';
          // ã€å…³é”®ä¿®æ”¹ã€‘(data.photos || [])
          (data.photos || []).forEach((p, idx) => {
            container.innerHTML += `
                      <div class="aspect-[3/4] bg-[#1a0505] border-2 border-red-900 relative p-1 cursor-pointer group" 
                           onclick="openSecretModal('photo', ${idx})">
                          <div class="w-full h-full bg-black flex-center overflow-hidden">
                              <div class="text-red-900/20 text-4xl font-bold rotate-45 select-none">NSFW</div>
                          </div>
                          <div class="absolute bottom-0 left-0 right-0 bg-red-900/90 text-[9px] text-white p-1 text-center truncate">
                              ${p.t}
                          </div>
                          <div class="absolute inset-0 bg-black/50 hidden group-hover:flex flex-center text-red-500 text-xs font-bold border border-red-500">æŸ¥çœ‹</div>
                      </div>`;
          });
          if (typeof lucide !== 'undefined') lucide.createIcons();
          return;
        } else if (tab === 'fantasy') {
          // ã€å…³é”®ä¿®æ”¹ã€‘(data.fantasies || [])
          (data.fantasies || []).forEach((f, idx) => {
            container.innerHTML += `
                      <div class="bg-[#1a0505] border-l-4 border-red-700 p-3 shadow-lg cursor-pointer hover:bg-[#2a0a0a] transition group" 
                           onclick="openSecretModal('fantasy', ${idx})">
                          <h3 class="text-sm font-bold text-red-500 mb-1 flex items-center gap-2">
                              <i data-lucide="book-open" class="w-3 h-3 group-hover:text-white transition"></i> ${f.t}
                          </h3>
                          <p class="text-[10px] text-red-900/80 line-clamp-2 font-mono">
                              ${f.c}
                          </p>
                      </div>`;
          });
        }
        container.className = 'space-y-4';

        if (typeof lucide !== 'undefined') {
          lucide.createIcons();
        }
      }

      function openSecretModal(type, idx) {
        const data = filesData.content.secret;
        let item;
        let typeText = '';
        if (type === 'audio') {
          item = data.audios[idx];
          typeText = 'AUDIO_RECORDING';
        } else if (type === 'photo') {
          item = data.photos[idx];
          typeText = 'PRIVATE_IMAGE';
        } else {
          item = data.fantasies[idx];
          typeText = 'FANTASY_SCRIPT';
        }
        document.getElementById('sm-type').innerText = typeText;
        document.getElementById('sm-title').innerText = item.t;
        document.getElementById('sm-content').innerText = item.c || item.desc;
        const modal = document.getElementById('secret-modal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
      }

      function openCollectionModal(idx) {
        const item = filesData.content.collection[idx];
        document.getElementById('cm-item').innerText = item.item;
        document.getElementById('cm-date').innerText = item.date;
        document.getElementById('cm-desc').innerText = item.desc;
        const modal = document.getElementById('collection-modal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
      }

      function goHome() {
        document.querySelectorAll('.app-view').forEach(e => e.classList.add('hidden'));
        document.getElementById('home-screen').classList.remove('hidden');
        document.getElementById('app-settings').classList.add('hidden');
        stopGlitch();
      }

      function handlePhysicalHome() {
        const settings = document.getElementById('app-settings');
        const home = document.getElementById('home-screen');
        const lock = document.getElementById('lock-screen');
        if (!settings.classList.contains('hidden')) {
          return;
        }
        let isAppOpen = false;
        document.querySelectorAll('.app-view').forEach(app => {
          if (!app.classList.contains('hidden')) isAppOpen = true;
        });
        if (!home.classList.contains('hidden') && !isAppOpen) {
          home.classList.add('hidden');
          lock.classList.remove('hidden');
        } else {
          goHome();
        }
      }

      function unlockPhone() {
        document.getElementById('lock-screen').classList.add('hidden');
        document.getElementById('home-screen').classList.remove('hidden');
      }

      function lockPhone() {
        document.getElementById('app-settings').classList.add('hidden');
        const noteModal = document.getElementById('browser-note-modal');
        if (noteModal) noteModal.classList.add('hidden');
        document.querySelectorAll('.app-view').forEach(e => e.classList.add('hidden'));
        document.getElementById('home-screen').classList.add('hidden');
        document.getElementById('lock-screen').classList.remove('hidden');
        stopGlitch();
      }

      function openApp(id) {
        document.getElementById('home-screen').classList.add('hidden');
        const app = document.getElementById('app-' + id);
        if (app) {
          app.classList.remove('hidden');
          if (id === 'settings') startGlitch();
        }
      }

      function toggleElement(id) {
        document.getElementById(id).classList.toggle('hidden');
      }

      function openWardrobeItem(idx) {
        const item = filesData.content.wardrobe[idx];
        document.getElementById('wd-name').innerText = item.name;
        document.getElementById('wd-rating').innerText = item.rating;
        document.getElementById('wd-comment').innerText = item.comment;
        document.getElementById(
          'wd-icon',
        ).innerHTML = `<i data-lucide="${item.icon}" class="w-16 h-16 text-${item.color}-400"></i>`;
        lucide.createIcons();
        document.getElementById('wardrobe-modal').classList.remove('hidden');
        document.getElementById('wardrobe-modal').classList.add('flex');
      }

      function closeWardrobeModal() {
        document.getElementById('wardrobe-modal').classList.add('hidden');
        document.getElementById('wardrobe-modal').classList.remove('flex');
      }

      function openFolder(id) {
        const data = filesData.content.files[id];
        document.getElementById('folder-title').innerText = data.title;
        const list = document.getElementById('file-list');
        list.innerHTML = '';
        data.items.forEach(item => {
          let icon = 'file';
          if (item.type === 'audio') icon = 'mic';
          if (item.type === 'video') icon = 'video';
          if (item.type === 'doc') icon = 'file-text';
          list.innerHTML += `
                    <div class="bg-white p-3 border-2 border-gray-200 shadow-[2px_2px_0_0_rgba(0,0,0,0.1)] flex items-center gap-3 cursor-pointer hover:bg-gray-50 active:translate-y-1 active:shadow-none transition" onclick="viewFile('${item.name}', '${item.desc}', '${item.type}')">
                        <div class="bg-gray-100 p-2 text-gray-600"><i data-lucide="${icon}" class="w-4 h-4"></i></div>
                        <div class="flex-1 min-w-0">
                            <div class="text-xs font-bold text-slate-800 truncate font-mono">${item.name}</div>
                        </div>
                    </div>`;
        });
        lucide.createIcons();
        document.getElementById('folder-view').classList.remove('hidden');
        document.getElementById('folder-view').classList.add('flex');
      }

      function viewFile(name, desc, type) {
        document.getElementById('file-name').innerText = name;
        document.getElementById('file-desc').innerText = desc;
        const screen = document.getElementById('player-screen');
        screen.innerHTML = '';
        if (type === 'audio') {
          screen.innerHTML = `<div class="flex items-center justify-center h-20 gap-1"><div class="w-1 bg-green-400 h-4 animate-pulse"></div><div class="w-1 bg-green-400 h-8 animate-pulse" style="animation-delay: 0.1s"></div><div class="w-1 bg-green-400 h-6 animate-pulse" style="animation-delay: 0.2s"></div><div class="w-1 bg-green-400 h-10 animate-pulse" style="animation-delay: 0.3s"></div><div class="w-1 bg-green-400 h-5 animate-pulse" style="animation-delay: 0.4s"></div></div><div class="absolute bottom-2 left-2 text-[10px] text-green-500 font-mono">PLAYING...</div>`;
        } else if (type === 'video') {
          screen.innerHTML = `<div class="flex items-center justify-center h-32 bg-black text-gray-600"><i data-lucide="play-circle" class="w-10 h-10"></i></div><div class="h-1 bg-gray-700 w-full absolute bottom-0"><div class="h-full bg-red-500 w-1/3"></div></div><div class="absolute top-2 right-2 text-[8px] text-red-500">REC â—</div>`;
        } else if (type === 'doc') {
          screen.innerHTML = `<div class="h-32 bg-white text-black p-2 text-[9px] font-mono text-left overflow-hidden">Document Content Preview...<br>Line 1: Valid<br>Line 2: Valid...</div>`;
        } else {
          screen.innerHTML = `<div class="h-32 flex-center text-red-500 text-xs font-mono">FILE CORRUPTED</div>`;
        }
        lucide.createIcons();
        document.getElementById('file-viewer').classList.remove('hidden');
        document.getElementById('file-viewer').classList.add('flex');
      }

      function closeFolder() {
        document.getElementById('folder-view').classList.add('hidden');
        document.getElementById('folder-view').classList.remove('flex');
      }

      function openChat(id, title) {
        document.getElementById('chat-title').innerText = title;
        const content = document.getElementById('chat-content');
        content.innerHTML = '';
        const msgs = filesData.content.messages.details[id] || [{ s: 'left', t: '(æ— æ›´å¤šæ¶ˆæ¯)', time: '' }];
        msgs.forEach(m => {
          const isRight = m.s === 'right';
          const bubbleClass = isRight ? 'pixel-bubble-right' : 'pixel-bubble-left';
          const justifyClass = isRight ? 'justify-end' : 'justify-start';
          const timeHtml = m.time
            ? `<span class="text-[9px] text-gray-400 mx-1 self-end mb-[2px] font-mono">${m.time}</span>`
            : '';
          const innerContent = isRight
            ? `${timeHtml}<div class="pixel-bubble ${bubbleClass}">${m.t}</div>`
            : `<div class="pixel-bubble ${bubbleClass}">${m.t}</div>${timeHtml}`;
          content.innerHTML += `<div class="flex w-full mb-3 ${justifyClass}">${innerContent}</div>`;
        });
        document.getElementById('chat-detail').classList.remove('hidden');
        document.getElementById('chat-detail').classList.add('flex');
      }

      function openBrowserNote(idx) {
        const note = filesData.content.browser[idx];
        const color = note.color || 'pink';
        const title = note.noteTitle || 'æ— æ ‡é¢˜ç¬”è®°';
        const content = note.noteContent || 'è¯¥é¡µé¢æš‚æ— å­¦ä¹ è®°å½•ã€‚';
        const titleEl = document.getElementById('bn-title');
        titleEl.innerText = title;
        document.getElementById('bn-content').innerText = content;
        document.getElementById(
          'bn-container',
        ).className = `bg-${color}-50 w-full border-4 border-${color}-500 shadow-2xl relative p-0 flex flex-col max-h-[400px]`;
        document.getElementById(
          'bn-header',
        ).className = `bg-${color}-500 text-white px-3 py-2 flex justify-between items-center border-b-4 border-${color}-700`;
        titleEl.className = `text-lg font-bold text-${color}-700 mb-4 border-b border-${color}-200 pb-2`;
        document.getElementById(
          'bn-footer',
        ).className = `bg-${color}-100 p-2 text-[9px] text-${color}-500 text-center border-t border-${color}-200`;
        document.getElementById('browser-note-modal').classList.remove('hidden');
        document.getElementById('browser-note-modal').classList.add('flex');
      }

      function decryptImg(el, t, d) {
        const cover = el.querySelector('.absolute');
        el.style.transform = 'translate(1px, 1px)';
        setTimeout(() => (el.style.transform = 'translate(-1px, -1px)'), 50);
        setTimeout(() => (el.style.transform = 'translate(0,0)'), 100);
        cover.style.transform = 'translateY(-100%)';
        setTimeout(() => {
          showLightbox(t, d);
          setTimeout(() => (cover.style.transform = 'translateY(0)'), 1000);
        }, 500);
      }

      function toggleTask(idx) {
        filesData.content.tasks.list[idx].done = !filesData.content.tasks.list[idx].done;
        renderAll();
        // if (typeof lucide !== 'undefined') lucide.createIcons(); // renderAll é‡Œå·²ç»åŠ äº†ï¼Œè¿™é‡Œå…¶å®å¯ä»¥çœç•¥ï¼Œæˆ–è€…ä¹ŸåŠ ä¸Šä¿é™©
      }

      function playGacha() {
        const display = document.getElementById('gacha-display');
        const pool = filesData.content.gacha.pool;
        let count = 0;
        display.innerHTML = `<div class="text-fuchsia-500 font-mono text-lg font-bold animate-pulse">ROLLING...</div>`;
        const interval = setInterval(() => {
          const randomItem = pool[Math.floor(Math.random() * pool.length)];
          display.innerHTML = `<div class="text-${randomItem.color}-500 font-bold text-sm">${randomItem.type}</div>`;
          count++;
          if (count > 10) {
            clearInterval(interval);
            showResult();
          }
        }, 100);
        function showResult() {
          const result = pool[Math.floor(Math.random() * pool.length)];
          let effect = '';
          if (result.type === 'SSR') effect = 'animate-bounce text-red-600 text-xl';
          else if (result.type === 'BAD') effect = 'text-black font-black bg-red-200 px-2';
          else effect = `text-${result.color}-500`;
          display.innerHTML = `
                  <div class="flex flex-col items-center">
                      <div class="text-xs text-gray-400 mb-1 font-mono tracking-widest">- RESULT -</div>
                      <div class="font-bold ${effect} mb-1">${result.type}</div>
                      <div class="text-sm font-bold text-slate-800 text-center px-2 leading-tight">${result.text}</div>
                  </div>
              `;
        }
      }
      // ==========================================
      //      æš´åŠ›æ ¼å¼åŒ–å·¥å…· (Force Formatter)
      // ==========================================

      function formatDebugInput() {
        const input = document.getElementById('debug-input');
        let text = input.value.trim();

        if (!text) return;

        // 1. å°è¯•æå–æ ‡ç­¾å†…çš„å†…å®¹ï¼Œä¿ç•™æ ‡ç­¾
        let header = '';
        let footer = '';
        let jsonContent = text;

        const tagMatch = text.match(/(<BOYFRIEND_DATA>)([\s\S]*?)(<\/BOYFRIEND_DATA>)/);
        if (tagMatch) {
          header = tagMatch[1] + '\n';
          jsonContent = tagMatch[2];
          footer = '\n' + tagMatch[3];
        } else if (text.startsWith('<BOYFRIEND_DATA>')) {
          // åªæœ‰å¼€å¤´æ ‡ç­¾çš„æƒ…å†µ
          header = '<BOYFRIEND_DATA>\n';
          jsonContent = text.replace('<BOYFRIEND_DATA>', '');
        }

        // 2. æš´åŠ›æ ¼å¼åŒ–æ ¸å¿ƒé€»è¾‘ (ä¸ä¾èµ– JSON.parseï¼Œå³ä½¿æ ¼å¼é”™è¯¯ä¹Ÿèƒ½ç¼©è¿›)
        let formatted = '';
        let indentLevel = 0;
        const indentStr = '  '; // ä¸¤ä¸ªç©ºæ ¼ç¼©è¿›
        let inString = false;
        let isEscaped = false;

        for (let i = 0; i < jsonContent.length; i++) {
          const char = jsonContent[i];

          // å¤„ç†å­—ç¬¦ä¸²å†…éƒ¨ï¼Œç›´æ¥åŸæ ·è¾“å‡ºï¼Œä¸å¤„ç†ä»»ä½•ç¬¦å·
          if (inString) {
            if (char === '\\' && !isEscaped) {
              isEscaped = true;
              formatted += char;
            } else if (char === '"' && !isEscaped) {
              inString = false;
              formatted += char;
            } else {
              isEscaped = false;
              formatted += char;
            }
            continue;
          }

          // å¤„ç†æ™®é€šå­—ç¬¦
          if (char === '"') {
            inString = true;
            formatted += char;
          } else if (char === '{' || char === '[') {
            formatted += char + '\n';
            indentLevel++;
            formatted += indentStr.repeat(indentLevel);
          } else if (char === '}' || char === ']') {
            formatted += '\n';
            indentLevel = Math.max(0, indentLevel - 1);
            formatted += indentStr.repeat(indentLevel);
            formatted += char;
          } else if (char === ',') {
            formatted += char + '\n';
            formatted += indentStr.repeat(indentLevel);
          } else if (char === ':') {
            formatted += ': ';
          } else if (/\s/.test(char)) {
            // è·³è¿‡ JSON ç»“æ„å¤–çš„å¤šä½™ç©ºæ ¼ï¼Œä¿æŒç´§å‡‘åé‡æ–°æ’ç‰ˆ
            // (ä»€ä¹ˆéƒ½ä¸åš)
          } else {
            formatted += char;
          }
        }

        // 3. å›å¡«åˆ°è¾“å…¥æ¡†
        input.value = header + formatted + footer;

        // 4. æç¤ºç”¨æˆ·
        const status = document.getElementById('debug-status');
        if (status) {
          status.style.color = '#60a5fa'; // Blue
          status.innerText = 'INFO: å·²æ ¼å¼åŒ–ï¼Œç°åœ¨ç‚¹å‡»æ³¨å…¥å¯å®šä½è¡Œå·';
        }
      }

      let glitchInt;
      const words = ['MINE', 'æ°¸è¿œ', 'æˆ‘çš„', 'ä¸è®¸è·‘', 'LOCK', 'WATCHING', 'å¬è¯', 'çˆ±', 'LOVE', 'FOREVER', 'OBEY'];
      function startGlitch() {
        const layer = document.getElementById('glitch-layer');
        layer.innerHTML = '';
        if (glitchInt) clearInterval(glitchInt);
        glitchInt = setInterval(() => {
          const span = document.createElement('div');
          span.innerText = words[Math.floor(Math.random() * words.length)];
          span.className = 'glitch-text';
          span.style.left = Math.random() * 90 + '%';
          span.style.top = Math.random() * 90 + '%';
          span.style.fontSize = Math.random() * 40 + 12 + 'px';
          layer.appendChild(span);
          if (layer.children.length > 50) layer.removeChild(layer.firstChild);
        }, 100);
      }
      function stopGlitch() {
        clearInterval(glitchInt);
        document.getElementById('glitch-layer').innerHTML = '';
      }

      setInterval(() => {
        const now = new Date();
        document.getElementById('clock').innerText = now.toLocaleTimeString('en-US', {
          hour12: false,
          hour: '2-digit',
          minute: '2-digit',
        });
      }, 1000);

      init();
    </script>
  </body>
</html>
